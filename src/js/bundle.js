(()=>{"use strict";class t{constructor(){this.health=t.HEALTH,this.armor=t.ARMOR,this.mass=t.MASS,this.armorStrength=t.ARMOR_STRENGTH}get num(){return t.NUM}}t.HEALTH=100,t.ARMOR=1,t.MASS=.8,t.ARMOR_STRENGTH=20,t.NUM=0;class e{constructor(){this.health=e.HEALTH,this.armor=e.ARMOR,this.mass=e.MASS,this.armorStrength=e.ARMOR_STRENGTH}get num(){return e.NUM}}e.HEALTH=90,e.ARMOR=1.1,e.MASS=.8,e.ARMOR_STRENGTH=25,e.NUM=1;class i{constructor(){this.health=i.HEALTH,this.armor=i.ARMOR,this.mass=i.MASS,this.armorStrength=i.ARMOR_STRENGTH}get num(){return i.NUM}}i.HEALTH=150,i.ARMOR=1,i.MASS=1.3,i.ARMOR_STRENGTH=20,i.NUM=2;class s{constructor(){this.health=s.HEALTH,this.armor=s.ARMOR,this.mass=s.MASS,this.armorStrength=s.ARMOR_STRENGTH}get num(){return s.NUM}}s.HEALTH=100,s.ARMOR=1.5,s.MASS=1.3,s.ARMOR_STRENGTH=30,s.NUM=3;class n{constructor(){this.health=n.HEALTH,this.armor=n.ARMOR,this.mass=n.MASS,this.armorStrength=n.ARMOR_STRENGTH}get num(){return n.NUM}}n.HEALTH=90,n.ARMOR=.9,n.MASS=.7,n.ARMOR_STRENGTH=18,n.NUM=4;class r{constructor(){this.health=r.HEALTH,this.armor=r.ARMOR,this.mass=r.MASS,this.armorStrength=r.ARMOR_STRENGTH}get num(){return r.NUM}}r.HEALTH=110,r.ARMOR=.5,r.MASS=.7,r.ARMOR_STRENGTH=20,r.NUM=5;class a{constructor(){this.health=a.HEALTH,this.armor=a.ARMOR,this.mass=a.MASS,this.armorStrength=a.ARMOR_STRENGTH}get num(){return a.NUM}}a.HEALTH=100,a.ARMOR=.6,a.MASS=.75,a.ARMOR_STRENGTH=22,a.NUM=6;class o{constructor(){this.health=o.HEALTH,this.armor=o.ARMOR,this.mass=o.MASS,this.armorStrength=o.ARMOR_STRENGTH}get num(){return o.NUM}}o.HEALTH=85,o.ARMOR=.6,o.MASS=.3,o.ARMOR_STRENGTH=25,o.NUM=7;class h{constructor(){this.angularData=Object.assign({},h.ANGULAR_DATA),this.forwardData=Object.assign({},h.FORWARD_DATA),this.backwardData=Object.assign({},h.BACKWARD_DATA)}get num(){return h.NUM}}h.ANGULAR_DATA={finishSpeed:.02,force:.03},h.FORWARD_DATA={finishSpeed:3,force:.025},h.BACKWARD_DATA={finishSpeed:2,force:.02},h.NUM=0;class l{constructor(){this.angularData=Object.assign({},l.ANGULAR_DATA),this.forwardData=Object.assign({},l.FORWARD_DATA),this.backwardData=Object.assign({},l.BACKWARD_DATA)}get num(){return l.NUM}}l.ANGULAR_DATA={finishSpeed:.019,force:.02},l.FORWARD_DATA={finishSpeed:3.5,force:.025},l.BACKWARD_DATA={finishSpeed:2.5,force:.02},l.NUM=1;class c{constructor(){this.angularData=Object.assign({},c.ANGULAR_DATA),this.forwardData=Object.assign({},c.FORWARD_DATA),this.backwardData=Object.assign({},c.BACKWARD_DATA)}get num(){return c.NUM}}c.ANGULAR_DATA={finishSpeed:.02,force:.02},c.FORWARD_DATA={finishSpeed:2,force:.035},c.BACKWARD_DATA={finishSpeed:1,force:.03},c.NUM=2;class _{constructor(){this.angularData=Object.assign({},_.ANGULAR_DATA),this.forwardData=Object.assign({},_.FORWARD_DATA),this.backwardData=Object.assign({},_.BACKWARD_DATA)}get num(){return _.NUM}}_.ANGULAR_DATA={finishSpeed:.03,force:.04},_.FORWARD_DATA={finishSpeed:2,force:.015},_.BACKWARD_DATA={finishSpeed:1,force:.01},_.NUM=3;class u{static get BACKGROUND_SIZE(){return u.fieldsX.BACKGROUND_SIZE}static get WALL_WIDTH(){return u.fieldsX.WALL_WIDTH}static get WALL_HEIGHT(){return u.fieldsY.WALL_HEIGHT}static get TRACK_INDENT(){return u.fieldsY.TRACK_INDENT}static get HULL_WIDTH(){return u.fieldsX.HULL_WIDTH}static get HULL_HEIGHT(){return u.fieldsY.HULL_HEIGHT}static get TURRET_INDENT_X(){return u.fieldsX.TURRET_INDENT_X}static get TURRET_WIDTH(){return u.fieldsX.TURRET_WIDTH}static get TURRET_HEIGHT(){return u.fieldsY.TURRET_HEIGHT}static get WEAPON_WIDTH(){return u.fieldsX.WEAPON_WIDTH}static get WEAPON_HEIGHT(){return u.fieldsY.WEAPON_HEIGHT}static get BULLET_WIDTH(){return u.fieldsX.BULLET_WIDTH}static get BULLET_HEIGHT(){return u.fieldsY.BULLET_HEIGHT}static get ACCELERATION_SIZE(){return u.fieldsX.ACCELERATION_SIZE}static get TANK_EXPLOSION_SIZE(){return u.fieldsX.TANK_EXPLOSION_SIZE}static get GRENADE_EXPLOSION_SIZE(){return u.fieldsX.GRENADE_EXPLOSION_SIZE}static get ACCELERATION_EFFECT_INDENT_X(){return u.fieldsX.ACCELERATION_EFFECT_INDENT_X}static get KEY_SIZE(){return u.fieldsX.KEY_SIZE}static get BOX_SIZE(){return u.fieldsX.BOX_SIZE}static get HEALTH_BAR_HEIGHT(){return u.fieldsY.HEALTH_BAR_HEIGHT}static get ARMOR_BAR_HEIGHT(){return u.fieldsY.ARMOR_BAR_HEIGHT}static get HEALTH_ARMOR_BAR_INDENT_Y(){return u.fieldsY.HEALTH_ARMOR_BAR_INDENT_Y}static getTankEntityWidth(t){return u.HULL_WIDTH[t]+u.TRACK_INDENT}static getTankEntityHeight(t){return u.HULL_HEIGHT[t]+(u.TRACK_INDENT<<1)}static resizeX(t){return Math.round(t*u.resizeWidthCoeff)}static resizeY(t){return Math.round(t*u.resizeWidthCoeff)}static setResolutionResizeCoeff(t){u.resizeWidthCoeff=t/u.DEVELOPING_SCREEN_WIDTH,u.resizeConstants()}static resizeConstants(){for(const t in u.fieldsX){const e=u.fieldsX[t];u.fieldsX[t]=Array.isArray(e)?e.map(u.resizeX):u.resizeX(e)}for(const t in u.fieldsY){const e=u.fieldsY[t];u.fieldsY[t]=Array.isArray(e)?e.map(u.resizeY):u.resizeY(e)}}}u.resizeWidthCoeff=1,u.DEVELOPING_SCREEN_WIDTH=1920,u.fieldsX={BACKGROUND_SIZE:115,WALL_WIDTH:[110,55],HULL_WIDTH:[63,67,64,53,67,67,63,57],TURRET_INDENT_X:[17,21,17,12,21,21,21,17],TURRET_WIDTH:[35,42,30,30,24,30,35,24],WEAPON_WIDTH:[39,41,33,35,42,30,35,30],BULLET_WIDTH:[13,18,25,26,21],ACCELERATION_SIZE:70,TANK_EXPLOSION_SIZE:99,GRENADE_EXPLOSION_SIZE:100,ACCELERATION_EFFECT_INDENT_X:[4,11,0,0,4,4,0,0,0],KEY_SIZE:55,BOX_SIZE:55},u.fieldsY={WALL_HEIGHT:[55,55],TRACK_INDENT:5,HULL_HEIGHT:[41,52,41,34,57,46,40,34],TURRET_HEIGHT:[30,30,19,30,24,24,30,24],WEAPON_HEIGHT:[12,9,12,6,9,13,12,12],BULLET_HEIGHT:[6,9,11,7,9],HEALTH_BAR_HEIGHT:10,ARMOR_BAR_HEIGHT:4,HEALTH_ARMOR_BAR_INDENT_Y:3};const d=Math.PI/180,m=["Grass","Ground","Sandstone"],E=["Rect","Square"],g=[[4,2],[5.5,2.5],[7,3]],A=[.55,.7,.85],T=11;var p;!function(t){t[t.bulLight=0]="bulLight",t[t.bulMedium=1]="bulMedium",t[t.bulHeavy=2]="bulHeavy",t[t.bulGrenade=3]="bulGrenade",t[t.bulSniper=4]="bulSniper",t[t.key=5]="key"}(p||(p={}));class I{constructor(){this.angleSpeed=I.ANGLE_SPEED,this.mass=I.MASS,this.bulletCapacity=I.BULLET_CAPACITY}get num(){return I.NUM}}I.ANGLE_SPEED=6e-4,I.MASS=.25,I.BULLET_CAPACITY=3,I.NUM=0;class M{constructor(){this.angleSpeed=M.ANGLE_SPEED,this.mass=M.MASS,this.bulletCapacity=M.BULLET_CAPACITY}get num(){return M.NUM}}M.ANGLE_SPEED=.001,M.MASS=.15,M.BULLET_CAPACITY=2,M.NUM=1;class S{constructor(){this.angleSpeed=S.ANGLE_SPEED,this.mass=S.MASS,this.bulletCapacity=S.BULLET_CAPACITY}get num(){return S.NUM}}S.ANGLE_SPEED=4e-4,S.MASS=.3,S.BULLET_CAPACITY=5,S.NUM=2;class L{constructor(){this.angleSpeed=L.ANGLE_SPEED,this.mass=L.MASS,this.bulletCapacity=L.BULLET_CAPACITY}get num(){return L.NUM}}L.ANGLE_SPEED=8e-4,L.MASS=.3,L.BULLET_CAPACITY=3,L.NUM=3;class R{constructor(){this.angleSpeed=R.ANGLE_SPEED,this.mass=R.MASS,this.bulletCapacity=R.BULLET_CAPACITY}get num(){return R.NUM}}R.ANGLE_SPEED=5e-4,R.MASS=.27,R.BULLET_CAPACITY=4,R.NUM=4;class C{constructor(){this.angleSpeed=C.ANGLE_SPEED,this.mass=C.MASS,this.bulletCapacity=C.BULLET_CAPACITY}get num(){return C.NUM}}C.ANGLE_SPEED=3e-4,C.MASS=.4,C.BULLET_CAPACITY=6,C.NUM=5;class w{constructor(){this.angleSpeed=w.ANGLE_SPEED,this.mass=w.MASS,this.bulletCapacity=w.BULLET_CAPACITY}get num(){return w.NUM}}w.ANGLE_SPEED=45e-5,w.MASS=.32,w.BULLET_CAPACITY=5,w.NUM=6;class f{constructor(){this.angleSpeed=f.ANGLE_SPEED,this.mass=f.MASS,this.bulletCapacity=f.BULLET_CAPACITY}get num(){return f.NUM}}f.ANGLE_SPEED=8e-4,f.MASS=.35,f.BULLET_CAPACITY=4,f.NUM=7;class N{constructor(){this.armorPenetrationCoeff=N.ARMOR_PENETRATION_COEFF,this.damageCoeff=N.DAMAGE_COEFF,this.startingSpeedCoeff=N.STARTING_SPEED_COEFF,this.reloadSpeed=N.RELOAD_SPEED,this.mass=N.MASS}get num(){return N.NUM}}N.ARMOR_PENETRATION_COEFF=1,N.DAMAGE_COEFF=1,N.STARTING_SPEED_COEFF=1,N.RELOAD_SPEED=1e3,N.MASS=.15,N.NUM=0;class D{constructor(){this.armorPenetrationCoeff=D.ARMOR_PENETRATION_COEFF,this.damageCoeff=D.DAMAGE_COEFF,this.startingSpeedCoeff=D.STARTING_SPEED_COEFF,this.reloadSpeed=D.RELOAD_SPEED,this.mass=D.MASS}get num(){return D.NUM}}D.ARMOR_PENETRATION_COEFF=.95,D.DAMAGE_COEFF=.95,D.STARTING_SPEED_COEFF=1.2,D.RELOAD_SPEED=900,D.MASS=.13,D.NUM=1;class P{constructor(){this.armorPenetrationCoeff=P.ARMOR_PENETRATION_COEFF,this.damageCoeff=P.DAMAGE_COEFF,this.startingSpeedCoeff=P.STARTING_SPEED_COEFF,this.reloadSpeed=P.RELOAD_SPEED,this.mass=P.MASS}get num(){return P.NUM}}P.ARMOR_PENETRATION_COEFF=1.2,P.DAMAGE_COEFF=1.1,P.STARTING_SPEED_COEFF=.8,P.RELOAD_SPEED=1200,P.MASS=.2,P.NUM=2;class y{constructor(){this.armorPenetrationCoeff=y.ARMOR_PENETRATION_COEFF,this.damageCoeff=y.DAMAGE_COEFF,this.startingSpeedCoeff=y.STARTING_SPEED_COEFF,this.reloadSpeed=y.RELOAD_SPEED,this.mass=y.MASS}get num(){return y.NUM}}y.ARMOR_PENETRATION_COEFF=.9,y.DAMAGE_COEFF=1.2,y.STARTING_SPEED_COEFF=1,y.RELOAD_SPEED=1100,y.MASS=.14,y.NUM=3;class O{constructor(){this.armorPenetrationCoeff=O.ARMOR_PENETRATION_COEFF,this.damageCoeff=O.DAMAGE_COEFF,this.startingSpeedCoeff=O.STARTING_SPEED_COEFF,this.reloadSpeed=O.RELOAD_SPEED,this.mass=O.MASS}get num(){return O.NUM}}O.ARMOR_PENETRATION_COEFF=1.1,O.DAMAGE_COEFF=.9,O.STARTING_SPEED_COEFF=1,O.RELOAD_SPEED=1e3,O.MASS=.15,O.NUM=4;class k{constructor(){this.armorPenetrationCoeff=k.ARMOR_PENETRATION_COEFF,this.damageCoeff=k.DAMAGE_COEFF,this.startingSpeedCoeff=k.STARTING_SPEED_COEFF,this.reloadSpeed=k.RELOAD_SPEED,this.mass=k.MASS}get num(){return k.NUM}}k.ARMOR_PENETRATION_COEFF=.7,k.DAMAGE_COEFF=.7,k.STARTING_SPEED_COEFF=1,k.RELOAD_SPEED=500,k.MASS=.18,k.NUM=5;class H{constructor(){this.armorPenetrationCoeff=H.ARMOR_PENETRATION_COEFF,this.damageCoeff=H.DAMAGE_COEFF,this.startingSpeedCoeff=H.STARTING_SPEED_COEFF,this.reloadSpeed=H.RELOAD_SPEED,this.mass=H.MASS}get num(){return H.NUM}}H.ARMOR_PENETRATION_COEFF=.6,H.DAMAGE_COEFF=1.4,H.STARTING_SPEED_COEFF=1.2,H.RELOAD_SPEED=1500,H.MASS=.25,H.NUM=6;class v{constructor(){this.armorPenetrationCoeff=v.ARMOR_PENETRATION_COEFF,this.damageCoeff=v.DAMAGE_COEFF,this.startingSpeedCoeff=v.STARTING_SPEED_COEFF,this.reloadSpeed=v.RELOAD_SPEED,this.mass=v.MASS}get num(){return v.NUM}}v.ARMOR_PENETRATION_COEFF=.75,v.DAMAGE_COEFF=1.3,v.STARTING_SPEED_COEFF=1.1,v.RELOAD_SPEED=1300,v.MASS=.22,v.NUM=7;class G{constructor(){this._hullKit=new U,this._trackKit=new U,this._turretKit=new U,this._weaponKit=new U,this._colorKit=new U,this._currTankIndex=0}static get CONTROL_1(){return{forwardKey:87,backwardKey:83,hullClockwiseKey:68,hullCounterClockwiseKey:65,turretClockwiseKey:86,turretCounterClockwiseKey:67,shootKey:66}}static get CONTROL_2(){return{forwardKey:38,backwardKey:40,hullClockwiseKey:39,hullCounterClockwiseKey:37,turretClockwiseKey:190,turretCounterClockwiseKey:188,shootKey:191}}start(t,e){this._gameStart=t,this.addHullsToKit(),this.addTracksToKit(),this.addTurretsToKit(),this.addWeaponsToKit(),this.addColorsToKit(),this.attachAllClickHandlers(e),this.resetChooseToDefault(),this.illustrateChoose()}addHullsToKit(){this._hullKit.addComponent(new t),this._hullKit.addComponent(new e),this._hullKit.addComponent(new i),this._hullKit.addComponent(new s),this._hullKit.addComponent(new n),this._hullKit.addComponent(new r),this._hullKit.addComponent(new a),this._hullKit.addComponent(new o)}addTracksToKit(){this._trackKit.addComponent(new h),this._trackKit.addComponent(new l),this._trackKit.addComponent(new c),this._trackKit.addComponent(new _)}addTurretsToKit(){this._turretKit.addComponent(new I),this._turretKit.addComponent(new M),this._turretKit.addComponent(new S),this._turretKit.addComponent(new L),this._turretKit.addComponent(new R),this._turretKit.addComponent(new C),this._turretKit.addComponent(new w),this._turretKit.addComponent(new f)}addWeaponsToKit(){this._weaponKit.addComponent(new N),this._weaponKit.addComponent(new D),this._weaponKit.addComponent(new P),this._weaponKit.addComponent(new y),this._weaponKit.addComponent(new O),this._weaponKit.addComponent(new k),this._weaponKit.addComponent(new H),this._weaponKit.addComponent(new v)}addColorsToKit(){this._colorKit.addComponent("rgb(77, 90, 121)"),this._colorKit.addComponent("rgb(120, 114, 77)"),this._colorKit.addComponent("rgb(140, 89, 77)"),this._colorKit.addComponent("rgb(82, 128, 124)")}resetChooseToDefault(){this._hullKit.currComponentIndex=0,this._trackKit.currComponentIndex=0,this._turretKit.currComponentIndex=0,this._weaponKit.currComponentIndex=0,this._colorKit.currComponentIndex=0}attachAllClickHandlers(t){for(const e of t)-1!==e.id.indexOf("prev")?(-1!==e.id.indexOf("Hull")&&e.addEventListener("click",(()=>this.switchToPrev(this._hullKit))),-1!==e.id.indexOf("Track")&&e.addEventListener("click",(()=>this.switchToPrev(this._trackKit))),-1!==e.id.indexOf("Turret")&&e.addEventListener("click",(()=>this.switchToPrev(this._turretKit))),-1!==e.id.indexOf("Weapon")&&e.addEventListener("click",(()=>this.switchToPrev(this._weaponKit))),-1!==e.id.indexOf("Color")&&e.addEventListener("click",(()=>this.switchToPrev(this._colorKit)))):-1!==e.id.indexOf("next")?(-1!==e.id.indexOf("Hull")&&e.addEventListener("click",(()=>this.switchToNext(this._hullKit))),-1!==e.id.indexOf("Track")&&e.addEventListener("click",(()=>this.switchToNext(this._trackKit))),-1!==e.id.indexOf("Turret")&&e.addEventListener("click",(()=>this.switchToNext(this._turretKit))),-1!==e.id.indexOf("Weapon")&&e.addEventListener("click",(()=>this.switchToNext(this._weaponKit))),-1!==e.id.indexOf("Color")&&e.addEventListener("click",(()=>this.switchToNext(this._colorKit)))):-1!==e.id.indexOf("accept")&&e.addEventListener("click",(()=>this.acceptChoose()))}switchToPrev(t){t.switchToPrevComponent(),this.illustrateChoose()}switchToNext(t){t.switchToNextComponent(),this.illustrateChoose()}determinePaths(){this._hullPath=`${G.DEFAULT_PATH}/Hulls/Hull_${this._hullKit.currComponentIndex}/Hull_${this._colorKit.currComponentIndex}.png`,this._trackPath=`${G.DEFAULT_PATH}/Tracks/Track_${this._trackKit.currComponentIndex}_Solo.png`,this._turretPath=`${G.DEFAULT_PATH}/Turrets/Turret_${this._turretKit.currComponentIndex}/Turret_${this._colorKit.currComponentIndex}.png`,this._weaponPath=`${G.DEFAULT_PATH}/Weapons/Weapon_${this._weaponKit.currComponentIndex}.png`}illustrateChoose(){this.determinePaths(),this.illustrateImages(),this.illustrateCharacteristics()}illustrateImages(){document.querySelector(".hull").src=this._hullPath,document.querySelector(".hull-view").src=this._hullPath,document.querySelector(".track").src=this._trackPath,document.querySelector(".track-bottom-view").src=this._trackPath,document.querySelector(".track-top-view").src=this._trackPath,document.querySelector(".turret").src=this._turretPath,document.querySelector(".turret-view").src=this._turretPath,document.querySelector(".weapon").src=this._weaponPath,document.querySelector(".weapon-view").src=this._weaponPath,document.querySelector(".color").style.backgroundColor=this._colorKit.currComponent}illustrateCharacteristics(){document.getElementById("hullInfo").textContent=this.getHullCharacteristic(),document.getElementById("trackInfo").textContent=this.getTrackCharacteristic(),document.getElementById("turretInfo").textContent=this.getTurretCharacteristic(),document.getElementById("weaponInfo").textContent=this.getWeaponCharacteristic()}getHullCharacteristic(){const t=this._hullKit.currComponent;return`Mass: ${t.mass} | Health: ${t.health} | Armor: ${t.armor} | Armor Strength: ${t.armorStrength}`}getTrackCharacteristic(){const t=this._trackKit.currComponent;return`Max Forward Speed: ${t.forwardData.finishSpeed} | Forward Acceleration: ${t.forwardData.force} | \n                Max Backward Speed: ${t.backwardData.finishSpeed} | Backward Acceleration: ${t.backwardData.force} |\n                Max Angular Speed: ${t.angularData.finishSpeed} | Angular Acceleration: ${t.angularData.force}`}getTurretCharacteristic(){const t=this._turretKit.currComponent;return`Mass: ${t.mass} | Angle Speed: ${t.angleSpeed} | Bullet Capacity: ${t.bulletCapacity}`}getWeaponCharacteristic(){const t=this._weaponKit.currComponent;return`Mass: ${t.mass} | Penetration: ${t.armorPenetrationCoeff} | Damage: ${t.damageCoeff} | Bullet Speed: ${t.startingSpeedCoeff} | Reload Speed: ${t.reloadSpeed}`}acceptChoose(){if(0===this._currTankIndex)this._currTankIndex++,this._attackerTankInfo={color:this._colorKit.currComponentIndex,hullNum:this._hullKit.currComponentIndex,trackNum:this._trackKit.currComponentIndex,turretNum:this._turretKit.currComponentIndex,weaponNum:this._weaponKit.currComponentIndex,control:G.CONTROL_1},this.resetChooseToDefault(),this.illustrateChoose();else if(1===this._currTankIndex){this._currTankIndex++;const t={color:this._colorKit.currComponentIndex,hullNum:this._hullKit.currComponentIndex,trackNum:this._trackKit.currComponentIndex,turretNum:this._turretKit.currComponentIndex,weaponNum:this._weaponKit.currComponentIndex,control:G.CONTROL_2};this._gameStart(this._attackerTankInfo,t)}}}G.DEFAULT_PATH="./src/img/tanks";class U{constructor(){this._kit=[],this._size=0,this._currComponentIndex=0}get currComponent(){return this._kit[this._currComponentIndex]}get currComponentIndex(){return this._currComponentIndex}set currComponentIndex(t){this._currComponentIndex=t}addComponent(t){this._kit[this._size++]=t}switchToPrevComponent(){this._currComponentIndex--,this._currComponentIndex<0&&(this._currComponentIndex=this._size-1)}switchToNextComponent(){this._currComponentIndex++,this._currComponentIndex>=this._size&&(this._currComponentIndex=0)}}class x{constructor(t,e){this._x=t,this._y=e}get x(){return this._x}set x(t){this._x=t}get y(){return this._y}set y(t){this._y=t}clone(){return new x(this._x,this._y)}addToCoordinates(t,e){this._x+=t,this._y+=e}}class F extends x{get length(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalize(){const t=this.length;0!==t&&(this._x/=t,this._y/=t)}get angle(){return Math.atan2(this.y,this.x)}clone(){return new F(this.x,this.y)}addVector(t){this._x+=t._x,this._y+=t._y}subtractVector(t){this._x-=t._x,this._y-=t._y}scale(t){this._x*=t,this._y*=t}}class W extends F{constructor(t,e){super(t,e)}static create(t,e){const i=new W(t.y-e.y,e.x-t.x);return i.normalize(),i}clone(){return new W(this._x,this._y)}}class b{constructor(){}static rotatePointAroundTarget(t,e,i,s){const n=t.x-e.x,r=t.y-e.y;t.x=e.x+n*s-r*i,t.y=e.y+n*i+r*s}static rotatePoint(t,e,i){const s=t.x,n=t.y;t.x=s*i-n*e,t.y=s*e+n*i}}class B{constructor(){}static movement(t){for(const e of t.points)e.addToCoordinates(t.velocity.x,t.velocity.y)}static angularMovement(t){B.rotateEntity(t,t.angularVelocity)}static rotateEntity(t,e){const i=Math.sin(e),s=Math.cos(e),n=t.calcCenter();for(const e of t.points)b.rotatePointAroundTarget(e,n,i,s);b.rotatePoint(t.velocity,i,s)}}function K(t,e){const i=e.x-t.x,s=e.y-t.y;return Math.sqrt(i*i+s*s)}function V(t,e=0,i=2*Math.PI){for(;t<e;)t+=i-e;for(;t>=i;)t-=i-e;return t}function X(t){return t>Math.PI/2&&t<3*Math.PI/2}function Y(t,e){return V(t-e)}function Z(t,e){return new x((t.x+e.x)/2,(t.y+e.y)/2)}class z{constructor(t,e,i,s,n,r){this._angularVelocity=0,this._velocity=new F(0,0);const a=e*e+i*i;this._radiusLength=.5*Math.sqrt(a),this._momentOfInertia=z.scalingCoeff*n*a,this._mass=n,this._id=r,this._width=e,this._height=i,this.adjustPolygon(t,e,i,s)}adjustPolygon(t,e,i,s){this._points=[t.clone(),new x(t.x+e,t.y),new x(t.x+e,t.y+i),new x(t.x,t.y+i)],0!==s&&B.rotateEntity(this,s)}get velocity(){return this._velocity}get angle(){return Math.atan2(this._points[1].y-this._points[0].y,this._points[1].x-this._points[0].x)}get points(){return this._points}get mass(){return this._mass}get angularVelocity(){return this._angularVelocity}set angularVelocity(t){this._angularVelocity=t}get id(){return this._id}get radiusLength(){return this._radiusLength}get momentOfInertia(){return this._momentOfInertia}calcCenter(){return Z(this._points[0],this._points[2])}get lengthwiseArea(){const t=this.angle-this._velocity.angle;return this._height*Math.abs(Math.cos(t))+this._width*Math.abs(Math.sin(t))}get movementLength(){const t=this.angle-this._velocity.angle;return this._width*Math.abs(Math.cos(t))+this._height*Math.abs(Math.sin(t))}}z.scalingCoeff=.3125;class ${constructor(){}static extractType(t){return t%$.TYPE_DIVIDER}static isTank(t){return $.extractType(t)===$.TANK_TYPE}static isWall(t){return $.extractType(t)===$.WALL_TYPE}static isBullet(t){return $.extractType(t)===$.BULLET_TYPE}static checkForMaxValue(t){if(t>=$.MAX_VALUE)throw new Error("Maximum ID is reached.")}static get tankId(){return $.checkForMaxValue($.TANK_ID),++$.TANK_ID*$.TYPE_DIVIDER+$.TANK_TYPE}static get wallId(){return $.checkForMaxValue($.WALL_ID),++$.WALL_ID*$.TYPE_DIVIDER+$.WALL_TYPE}static get bulletId(){return $.checkForMaxValue($.BULLET_ID),++$.BULLET_ID*$.TYPE_DIVIDER+$.BULLET_TYPE}static get collectibleItemId(){return $.checkForMaxValue($.COLLECTIBLE_ITEM_ID),++$.COLLECTIBLE_ITEM_ID*$.TYPE_DIVIDER+$.COLLECTIBLE_ITEM_TYPE}static get quadtreeBoundaryId(){return $.checkForMaxValue($.QUADTREE_BOUNDARY_ID),++$.QUADTREE_BOUNDARY_ID*$.TYPE_DIVIDER+$.QUADTREE_BOUNDARY_TYPE}static get otherId(){return $.checkForMaxValue($.OTHER_ID),++$.OTHER_ID*$.TYPE_DIVIDER+$.OTHER_TYPE}}$.TANK_TYPE=0,$.WALL_TYPE=1,$.BULLET_TYPE=2,$.COLLECTIBLE_ITEM_TYPE=3,$.QUADTREE_BOUNDARY_TYPE=4,$.OTHER_TYPE=5,$.TYPE_DIVIDER=1e3,$.MAX_VALUE=Math.floor(Number.MAX_SAFE_INTEGER/$.TYPE_DIVIDER)-1,$.TANK_ID=0,$.WALL_ID=0,$.BULLET_ID=0,$.COLLECTIBLE_ITEM_ID=0,$.QUADTREE_BOUNDARY_ID=0,$.OTHER_ID=0;class j{constructor(){this.startingSpeed=j.STARTING_SPEED,this.damage=j.DAMAGE,this.armorPenetration=j.ARMOR_PENETRATION,this.mass=j.MASS,this.health=j.HEALTH}get num(){return j.NUM}}j.STARTING_SPEED=45,j.DAMAGE=12,j.ARMOR_PENETRATION=.05,j.MASS=.008,j.HEALTH=5,j.NUM=0;class q{constructor(){this.startingSpeed=q.STARTING_SPEED,this.damage=q.DAMAGE,this.armorPenetration=q.ARMOR_PENETRATION,this.mass=q.MASS,this.health=q.HEALTH}get num(){return q.NUM}}q.STARTING_SPEED=35,q.DAMAGE=25,q.ARMOR_PENETRATION=.1,q.MASS=.02,q.HEALTH=10,q.NUM=1;class Q{constructor(){this.startingSpeed=Q.STARTING_SPEED,this.damage=Q.DAMAGE,this.armorPenetration=Q.ARMOR_PENETRATION,this.mass=Q.MASS,this.health=Q.HEALTH}get num(){return Q.NUM}}Q.STARTING_SPEED=15,Q.DAMAGE=50,Q.ARMOR_PENETRATION=.2,Q.MASS=.05,Q.HEALTH=20,Q.NUM=2;class J{constructor(){this.startingSpeed=J.STARTING_SPEED,this.damage=J.DAMAGE,this.armorPenetration=J.ARMOR_PENETRATION,this.mass=J.MASS,this.health=J.HEALTH}get num(){return J.NUM}}J.STARTING_SPEED=75,J.DAMAGE=35,J.ARMOR_PENETRATION=.5,J.MASS=.01,J.HEALTH=6,J.NUM=3;class tt{constructor(){this.startingSpeed=tt.STARTING_SPEED,this.damage=tt.DAMAGE,this.armorPenetration=tt.ARMOR_PENETRATION,this.mass=tt.MASS,this.health=tt.HEALTH}get num(){return tt.NUM}createAffectedArea(t,e,i){const s=new x(t.x-e/2,t.y-e/2);return new z(s,e,e,i,this.mass,$.otherId)}}tt.STARTING_SPEED=10,tt.DAMAGE=40,tt.ARMOR_PENETRATION=.25,tt.MASS=.035,tt.HEALTH=15,tt.NUM=4;class et{constructor(){}static calcAcceleration(t,e,i,s,n,r,a){return(t-e*r*.01-i*n*n*a)/r*(s/17)}static calcAngularAcceleration(t,e,i,s,n,r,a,o){return this.calcAcceleration(t,e,i,s,n,r,a)/o}}class it{constructor(){}static calcAcceleration(t,e,i,s,n,r){return(t-e*s*s*r)/n*(i/17)}static calcAngularAcceleration(t,e,i,s,n,r,a){return this.calcAcceleration(t,e,i,s,n,r)/a}}class st{constructor(t,e){this._entity=t,this._health=e}get health(){return this._health}isDead(){return this._health<=0}get entity(){return this._entity}isIdle(){return 0===this._entity.velocity.length}isAngularMotionStopped(){return 0===this._entity.angularVelocity}applyVelocityChange(t,e){const i=this._entity,s=Math.sign(i.velocity.x),n=Math.sign(i.velocity.y);i.velocity.addToCoordinates(t*Math.cos(e),t*Math.sin(e)),s!==Math.sign(i.velocity.x)&&(i.velocity.x=0),n!==Math.sign(i.velocity.y)&&(i.velocity.y=0)}applyAngularVelocityChange(t){const e=this._entity,i=e.angularVelocity;i>0?e.angularVelocity+=i+t<0?-i:t:e.angularVelocity-=i+t>0?-i:t}takeDamage(t){this._health-=t.damage}}class nt extends st{residualMovement(t,e,i){const s=this._entity,n=et.calcAcceleration(0,t,e,i,s.velocity.length,s.mass,s.lengthwiseArea);this.applyVelocityChange(n,s.velocity.angle)}residualAngularMovement(t,e,i){const s=this._entity,n=et.calcAngularAcceleration(0,t,e,i,s.angularVelocity,s.mass,s.lengthwiseArea,s.radiusLength);this.applyAngularVelocityChange(n)}}class rt extends st{residualMovement(t,e){const i=this._entity,s=it.calcAcceleration(0,t,e,i.velocity.length,i.mass,i.lengthwiseArea);this.applyVelocityChange(s,i.velocity.angle)}residualAngularMovement(t,e){const i=this._entity,s=it.calcAngularAcceleration(0,t,e,i.angularVelocity,i.mass,i.lengthwiseArea,i.radiusLength);this.applyAngularVelocityChange(s)}}class at extends rt{constructor(t,e){super(e,t.health),this._bullet=t}get maxHealth(){return this._bullet.health}get damage(){return this._bullet.damage}get armorPenetration(){return this._bullet.armorPenetration}get isExplosiveBullet(){const t=this._bullet;return"createAffectedArea"in t?t:null}}class ot{constructor(){}static create(t,e,i,s){const n=ot.createBullet(t),r=ot.calcDefaultEntityPoint(t,e,i),a=new z(r,u.BULLET_WIDTH[t],u.BULLET_HEIGHT[t],i,n.mass,$.bulletId);return n.damage*=s.damageCoeff,n.armorPenetration*=s.armorPenetrationCoeff,n.startingSpeed*=s.startingSpeedCoeff,a.velocity.x=n.startingSpeed*Math.cos(i),a.velocity.y=n.startingSpeed*Math.sin(i),new at(n,a)}static calcDefaultEntityPoint(t,e,i){const s=new x(e.x+u.BULLET_HEIGHT[t]/2*Math.sin(i),e.y-u.BULLET_HEIGHT[t]/2*Math.cos(i)),n=Math.sin(i),r=Math.cos(i),a=new x(s.x+u.BULLET_WIDTH[t]/2*r-u.BULLET_HEIGHT[t]/2*n,s.y+u.BULLET_HEIGHT[t]/2*r+u.BULLET_WIDTH[t]/2*n);return b.rotatePointAroundTarget(s,a,-n,r),s}static createBullet(t){switch(t){case 0:return new j;case 1:return new q;case 2:return new Q;case 3:return new J;case 4:return new tt;default:throw new Error(`Bullet model ${t} was not found`)}}}function ht(t,e){return Math.floor(Math.random()*(e+1-t))+t}class lt extends nt{get maxHealth(){return this._tankParts.hull.health}get maxArmor(){return this._tankParts.hull.armor}constructor(t,e){super(e,t.hull.health),this._lastTimeShot=performance.now(),this._bulletQuantity=0,this._bulletNum=lt.DEFAULT_BULLET_NUM,this._isBraking=!1,this._isDrift=!1,this._tankParts=t,this._turretAngle=e.angle,this._armor=t.hull.armor}takeDamage(t){this._armor-=t.armorPenetration,this._armor<0&&(this._armor=0);const e=t.damage-this._armor*this.armorStrength;e>0&&(this._health-=e)}get turretAngle(){return this._turretAngle}get armor(){return this._armor}get armorStrength(){return this._tankParts.hull.armorStrength}get bulletNum(){return this._bulletNum}shot(){const t=performance.now();if(t-this._lastTimeShot<this._tankParts.weapon.reloadSpeed)return null;0===this._bulletQuantity?this._bulletNum=lt.DEFAULT_BULLET_NUM:this._bulletQuantity--;const e=ot.create(this._bulletNum,this.calcBulletExit(),this._turretAngle,this._tankParts.weapon);return this._lastTimeShot=t,e}calcBulletExit(){const t=this._entity.calcCenter(),e=this._tankParts,i=(n=e.turret,u.TURRET_WIDTH[n.num]/2+(s=e.weapon,u.WEAPON_WIDTH[s.num]));var s,n;const r=t.x+i*Math.cos(this._turretAngle),a=t.y+i*Math.sin(this._turretAngle);return new x(r,a)}takeBullet(t){this._bulletNum=t,this._bulletQuantity=this._tankParts.turret.bulletCapacity}turretClockwiseMovement(t){this._turretAngle+=this._tankParts.turret.angleSpeed*t}turretCounterclockwiseMovement(t){this._turretAngle-=this._tankParts.turret.angleSpeed*t}incTurretAngle(t){this._turretAngle+=t}clockwiseMovement(t,e,i){const s=this._entity,n=this._tankParts.track.angularData;s.angularVelocity<n.finishSpeed&&(s.angularVelocity+=et.calcAngularAcceleration(n.force,t,e,i,s.angularVelocity,s.mass,s.lengthwiseArea,s.radiusLength)),this.updateAngularVelocity(),this.incTurretAngle(s.angularVelocity)}counterclockwiseMovement(t,e,i){const s=this._entity,n=this._tankParts.track.angularData;-s.angularVelocity<n.finishSpeed&&(s.angularVelocity-=et.calcAngularAcceleration(n.force,t,e,i,s.angularVelocity,s.mass,s.lengthwiseArea,s.radiusLength)),this.updateAngularVelocity(),this.incTurretAngle(s.angularVelocity)}updateAngularVelocity(){if(this.isIdle())return;const t=this._entity,e=t.velocity;(this._isDrift||this._isBraking)&&this.incAngularVelocity(t,e),this._isBraking||this.decAngularVelocity(t,e)}incAngularVelocity(t,e){const i=this.calcCoeff(),s=1+e.length/(this._tankParts.track.forwardData.finishSpeed*i),n=1+t.mass/(10*i);t.angularVelocity*=n*s}calcCoeff(){let t=100;return this._isDrift&&(t-=25),this._isBraking&&(t-=5),t}decAngularVelocity(t,e){const i=1-e.length/(20*this._tankParts.track.forwardData.finishSpeed),s=1-t.mass/200;t.angularVelocity*=s*i,e.scale(s)}forwardMovement(t,e,i){this.movement(this._tankParts.track.forwardData,this._entity.angle,t,e,i)}backwardMovement(t,e,i){this.movement(this._tankParts.track.backwardData,this._entity.angle+Math.PI,t,e,i)}movement(t,e,i,s,n){const r=this._entity,a=r.velocity.length,o=0===a?e:r.velocity.angle,h=Y(e,o);this.setBrakingStatus(h),lt.isStraightMovement(h)?(this._isDrift=!1,this.handleStraightMovement(t,i,s,n,a,o)):(this._isDrift=!lt.isReverseMovement(h),this._isDrift&&(this.determineDribbleSpeed(h),this.applyTurn(this.calcShortestTurn(h))),this.handleDriftMovement(t,i,s,n,a,h,o))}setBrakingStatus(t){this._isBraking=X(t)}calcShortestTurn(t){return this._isBraking&&(t=lt.adjustTurnForBraking(t)),t=lt.adjustTurnForRecovery(t)}static isStraightMovement(t){return t<=d||2*Math.PI-t<=d}static isReverseMovement(t){return Math.abs(t-Math.PI)<=d}handleStraightMovement(t,e,i,s,n,r){if(n<t.finishSpeed){const a=et.calcAcceleration(t.force,e,i,s,n,this._entity.mass,this._entity.lengthwiseArea);this._entity.velocity.addToCoordinates(a*Math.cos(r),a*Math.sin(r))}}handleDriftMovement(t,e,i,s,n,r,a){if(this._isBraking||n<t.finishSpeed){const o=et.calcAcceleration(t.force*Math.cos(r),e,i,s,n,this._entity.mass,this._entity.lengthwiseArea);this.applyVelocityChange(o,a)}}static adjustTurnForBraking(t){return V(t-Math.PI/2)}static adjustTurnForRecovery(t){const e=t-2*Math.PI;return t>Math.abs(e)?e:t}applyTurn(t){t*=lt.VELOCITY_RECOVERY_COEFF*this._entity.mass,b.rotatePoint(this._entity.velocity,Math.sin(t),Math.cos(t))}determineDribbleSpeed(t){const e=(Math.abs(Math.cos(t))-(i=0))/(1-i)*(1-(s=.95))+s;var i,s;this._entity.velocity.scale(e)}residualMovement(t,e,i){const s=Y(this._entity.angle,this._entity.velocity.angle);(this._isDrift||!lt.isStraightMovement(s)&&!lt.isReverseMovement(s))&&(this._isDrift=!0,this.determineDribbleSpeed(s)),this._isBraking=!1,super.residualMovement(t,e,i)}residualAngularMovement(t,e,i){this.updateAngularVelocity(),super.residualAngularMovement(t,e,i),this.incTurretAngle(this._entity.angularVelocity)}}lt.DEFAULT_BULLET_NUM=0,lt.VELOCITY_RECOVERY_COEFF=.017;class ct{constructor(){}static extractZIndex(t){return t%ct.Z_INDEX_DIVIDER}static checkForMaxValue(t){if(t>=ct.MAX_VALUE)throw new Error("Maximum ID is reached.")}static generate(t){for(let e=this.IDs.length;e<=t;e++)ct.IDs.push(0);return ct.checkForMaxValue(ct.IDs[t]),++ct.IDs[t]*ct.Z_INDEX_DIVIDER+t}}ct.Z_INDEX_DIVIDER=1e3,ct.MAX_VALUE=Math.floor(Number.MAX_SAFE_INTEGER/ct.Z_INDEX_DIVIDER)-1,ct.IDs=new Array;class _t{constructor(t,e,i){this._imgSprite=new Image(t,e),this._imgSprite.classList.add("sprite"),this._id=ct.generate(i)}get imgSprite(){return this._imgSprite}get width(){return this._imgSprite.width}get height(){return this._imgSprite.height}get id(){return this._id}get point(){return this._point}get angle(){return this._angle}set point(t){this._point=t}set angle(t){this._angle=t}}class ut extends _t{constructor(t,e,i){super(t,e,1),this._opacity=1,this._imgSprite.src=`src/img/tanks/Effects/Tire Tracks/Tire_Track_Chain_${i}.png`}get opacity(){return this._opacity}set opacity(t){this._opacity=t}}class dt{get value(){return this._value}get prev(){return this._prev}get next(){return this._next}set next(t){this._next=t}set prev(t){this._prev=t}constructor(t){this._prev=null,this._next=null,this._value=t}remove(){null!==this._prev&&(this._prev.next=this._next),null!==this._next&&(this._next.prev=this._prev),this._prev=null,this._next=null}}class mt{constructor(){this._tail=null,this._head=null,this._length=0}get head(){return null!==this._head?this._head.value:null}get tail(){return null!==this._tail?this._tail.value:null}get length(){return this._length}*[Symbol.iterator](){let t=this._head;for(let e=this._length;e>0;e--)yield t.value,t=t.next}applyAndRemove(t,e,i){let s=this._head;for(;null!==s;)if(t(s.value,i),e(s.value)){const t=s;s=s.next,this.removeNode(t)}else s=s.next}isEmpty(){return 0===this._length}remove(t){let e=this._head;for(;null!==e;){if(e.value===t)return void this.removeNode(e);e=e.next}}removeNode(t){t===this._tail&&(this._tail=t.prev),t===this._head&&(this._head=t.next),this._length--,t.remove()}addToHead(t){const e=new dt(t);null===this._head?(this._tail=e,this._head=e):(e.next=this._head,this._head.prev=e,this._head=e),this._length++}addToTail(t){const e=new dt(t);null===this._tail?(this._tail=e,this._head=e):(e.prev=this._tail,this._tail.next=e,this._tail=e),this._length++}removeFromTail(){this._tail===this._head?this.clear():(this._tail=this._tail.prev,this._tail.next=null,this._length--)}removeFromHead(){this._tail===this._head?this.clear():(this._head=this._head.next,this._head.prev=null,this._length--)}moveToTail(t){let e=this._tail;for(;null!==e;){if(e.value===t){if(e!==this._tail){const t=e.prev,i=e.next;null!==t&&(t.next=i),null!==i&&(i.prev=t),e.next=null,e.prev=this._tail,this._tail.next=e,this._tail=e}return}e=e.prev}}moveToHead(t){let e=this._head;for(;null!==e;){if(e.value===t){if(e!==this._head){const t=e.prev,i=e.next;null!==t&&(t.next=i),null!==i&&(i.prev=t),e.next=this._head,e.prev=null,this._head.prev=e,this._head=e}return}e=e.next}}clear(){this._tail=this._head=null,this._length=0}}class Et{constructor(){}static rotateToDefaultSpritePoint(t,e,i,s){const n=t.width>>1,r=t.height>>1;b.rotatePointAroundTarget(e,new x(e.x+n*s-r*i,e.y+r*s+n*i),-i,s)}static updateSpritePart(t,e,i,s,n){Et.rotateToDefaultSpritePoint(t,e,i,s),Et.setPosAndAngle(t,e,n)}static setPosAndAngle(t,e,i){t.point=e,t.angle=i}static rotateForTurretPoint(t,e,i,s,n,r){const a=t.width>>1,o=t.height>>1;b.rotatePointAroundTarget(e,new x(e.x+a*s-o*i,e.y+o*s+a*i),n*s-r*i,s*r+i*n)}}class gt extends _t{constructor(t,e,i){super(t,e,1),this._opacity=1,this._imgSprite.src=`src/img/tanks/Effects/Tire Tracks/Tire_Track_${i}.png`}get opacity(){return this._opacity}set opacity(t){this._opacity=t}}var At,Tt;!function(t){t[t.dirForward=1]="dirForward",t[t.dirRotate=0]="dirRotate",t[t.dirBackward=1]="dirBackward"}(At||(At={}));class pt{get chainWidth(){return this._chainWidth}constructor(t,e,i){this._listOfTirePairs=new mt,this._vanishingListOfTirePairs=i,this._storage=t,this._trackWidth=e.width,this._trackHeight=e.height,this._chainWidth=this.calcWidthOfChain(),this._chainHeight=e.height,this._tireTrackType=Math.floor(e.num/2)}calcWidthOfChain(){return this._trackWidth/pt.AMOUNT_OF_CHAINS}static calcPositionOfFirstChain(t,e,i,s,n){return new x(t.x+e*n-i*n,t.y+e*s-i*s)}moveToNextChain(t,e,i){t.x=t.x-this._chainWidth*i,t.y=t.y-this._chainWidth*e}vanishFullTrack(){for(const t of this._listOfTirePairs)this._vanishingListOfTirePairs.addToHead(this._listOfTirePairs.head),this._listOfTirePairs.removeFromHead()}static setAndPosTireTrackPair(t,e,i,s,n,r){const a=e.clone(),o=i.clone();Et.rotateToDefaultSpritePoint(t.topTire,a,n,r),Et.rotateToDefaultSpritePoint(t.bottomTire,o,n,r),Et.setPosAndAngle(t.topTire,a,s),Et.setPosAndAngle(t.bottomTire,o,s)}createTireTrackChainPair(t,e,i,s,n){const r={topTire:new ut(this._chainWidth,this._chainHeight,this._tireTrackType),bottomTire:new ut(this._chainWidth,this._chainHeight,this._tireTrackType)};return this._storage.insert(r.topTire),this._storage.insert(r.bottomTire),pt.setAndPosTireTrackPair(r,t,e,i,s,n),r}createTireTrackPair(t,e,i,s,n){this.vanishFullTrack();const r={topTire:new gt(this._trackWidth,this._trackHeight,this._tireTrackType),bottomTire:new gt(this._trackWidth,this._trackHeight,this._tireTrackType)};this._storage.insert(r.topTire),this._storage.insert(r.bottomTire),pt.setAndPosTireTrackPair(r,t,e,i,s,n),this._listOfTirePairs.addToHead(r)}calcFirstTopBottomChainPoints(t,e,i,s){const n=pt.calcPositionOfFirstChain(e,this._trackWidth,this.chainWidth,i,s),r=t.hullSprite.calcPosition(e,i,s);let a=t.bottomTrackSprite.calcPosition(r,i,s);return a=pt.calcPositionOfFirstChain(a,this._trackWidth,this.chainWidth,i,s),{topFirstChainPoint:n,bottomFirstChainPoint:a}}calcLastTopBottomChainPoints(t,e,i,s){const n=e.clone(),r=t.hullSprite.calcPosition(e,i,s);return{topLastChainPoint:n,bottomLastChainPoint:t.bottomTrackSprite.calcPosition(r,i,s)}}spawnFullTireTrack(t,e,i,s,n){this._topFirstChainPoint=t.clone(),this._bottomFirstChainPoint=e.clone();for(let r=0;r<pt.AMOUNT_OF_CHAINS;r++){const a=this.createTireTrackChainPair(t,e,i,s,n);this._listOfTirePairs.addToHead(a),r===pt.AMOUNT_OF_CHAINS-1&&(this._topLastChainPoint=t.clone(),this._bottomLastChainPoint=e.clone()),this.moveToNextChain(t,s,n),this.moveToNextChain(e,s,n)}}updateAllChainPoints(t,e,i,s){this._topFirstChainPoint=t,this._bottomFirstChainPoint=e,this._topLastChainPoint=i,this._bottomLastChainPoint=s}checkForUpdate(t,e,i,s){const n=K(t,this._topFirstChainPoint),r=K(e,this._bottomFirstChainPoint),a=K(i,this._topLastChainPoint),o=K(s,this._bottomLastChainPoint);return n>=this._chainWidth?{isUpdate:!0,prevPoint:this._topFirstChainPoint,currPoint:t}:r>=this._chainWidth?{isUpdate:!0,prevPoint:this._bottomFirstChainPoint,currPoint:e}:a>=this._chainWidth?{isUpdate:!0,prevPoint:this._topLastChainPoint,currPoint:i}:o>=this._chainWidth?{isUpdate:!0,prevPoint:this._bottomLastChainPoint,currPoint:s}:{isUpdate:!1}}getMovementAngle(t,e){const i=e.x-t.x,s=e.y-t.y;return Math.atan2(s,i)}detectMovementDirection(t,e,i){const s=this.getMovementAngle(t,e);let n=V(i-pt.DIRECTION_ANGLE_DIFFERENCE,-Math.PI,Math.PI),r=V(i+pt.DIRECTION_ANGLE_DIFFERENCE,-Math.PI,Math.PI),a=!1;if(n>=Math.PI/2&&n<=Math.PI&&r>=-Math.PI&&r<=-Math.PI/2&&(a=!0,s>=0?r=V(r,0,2*Math.PI):n=V(n,-2*Math.PI,0)),s>=n&&s<=r||s<=n&&s>=r)return At.dirForward;{a&&(n<0?(n=V(n,0,2*Math.PI),r=V(r,0,2*Math.PI)):(n=V(n,-2*Math.PI,0),r=V(r,-2*Math.PI,0)));const t=V(s-Math.PI,-Math.PI,Math.PI);return t>=n&&t<=r||t<=n&&t>=r?At.dirBackward:At.dirRotate}}forwardUpdate(t,e,i,s,n){const r=this.createTireTrackChainPair(t,e,i,s,n);this._listOfTirePairs.addToTail(r),this._listOfTirePairs.length>pt.AMOUNT_OF_CHAINS&&(this._vanishingListOfTirePairs.addToHead(this._listOfTirePairs.head),this._listOfTirePairs.removeFromHead())}backwardUpdate(t,e,i,s,n){const r=this.createTireTrackChainPair(t,e,i,s,n);this._listOfTirePairs.addToHead(r),this._listOfTirePairs.length>pt.AMOUNT_OF_CHAINS&&(this._vanishingListOfTirePairs.addToHead(this._listOfTirePairs.tail),this._listOfTirePairs.removeFromTail())}}pt.DIRECTION_ANGLE_DIFFERENCE=.6,pt.AMOUNT_OF_CHAINS=10;class It extends _t{constructor(){super(u.ACCELERATION_SIZE,u.ACCELERATION_SIZE,2),this._frame=0,this._imgSprite.src="src/img/tanks/Effects/Movement/Movement.png"}set frame(t){this._frame=t}get frame(){return this._frame}get originalWidth(){return It.ORIGINAL_SIZE}get originalHeight(){return It.ORIGINAL_SIZE}}It.ORIGINAL_SIZE=256;class Mt{constructor(t,e,i){this._topSpriteAccelerationEffect=new It,this._bottomSpriteAccelerationEffect=new It,this._counter=0,this._frame=0,this._storage=t,this._indentX=e,this._tankHeight=i}changeFrame(){this._frame===Mt.LAST_Frame&&(this._frame=Mt.WORKING_Frame),this._counter++,this._counter===Mt.THRESHOLD&&(this._counter=0,this._frame++,this._topSpriteAccelerationEffect.frame=this._frame,this._bottomSpriteAccelerationEffect.frame=this._frame)}setPosition(t,e,i,s){0===this._frame&&0===this._counter&&(this._storage.insert(this._topSpriteAccelerationEffect),this._storage.insert(this._bottomSpriteAccelerationEffect)),this.changeFrame();let n=this.calcPosition(t,e,i,28*this._tankHeight/42);Et.updateSpritePart(this._topSpriteAccelerationEffect,n,e,i,s),n=this.calcPosition(t,e,i,37*this._tankHeight/42),Et.updateSpritePart(this._bottomSpriteAccelerationEffect,n,e,i,s)}removeAcceleration(){if(0===this._frame&&0===this._counter)return;this._frame=0,this._counter=0;const t=this._topSpriteAccelerationEffect,e=this._bottomSpriteAccelerationEffect;t.frame=this._frame,e.frame=this._frame,this._storage.remove(this._topSpriteAccelerationEffect),this._storage.remove(this._bottomSpriteAccelerationEffect)}calcPosition(t,e,i,s){return new x(t.x+this._indentX*i-s*e-u.ACCELERATION_SIZE/2*i+u.ACCELERATION_SIZE/1.517*e,t.y+s*i+this._indentX*e-u.ACCELERATION_SIZE/1.517*i-u.ACCELERATION_SIZE/2*e)}}Mt.THRESHOLD=7,Mt.LAST_Frame=19,Mt.WORKING_Frame=10;class St{constructor(t,e){this._frame=0,this._counter=0,this._isForwardMovement=!0,this._isResidualMovement=!1,this._minFrameChangeThreshold=[Math.max(Math.round(St.MIN_THRESHOLD_COEFF/e.finishSpeed),St.MIN_FRAME_CHANGE_THRESHOLD_MINIMUM),Math.max(Math.round(St.MIN_THRESHOLD_COEFF/t.finishSpeed),St.MIN_FRAME_CHANGE_THRESHOLD_MINIMUM)],this._maxFrameChangeThreshold=[Math.min(Math.round(St.MAX_THRESHOLD_COEFF/e.force),St.MAX_FRAME_CHANGE_THRESHOLD_MAXIMUM),Math.min(Math.round(St.MAX_THRESHOLD_COEFF/t.force),St.MAX_FRAME_CHANGE_THRESHOLD_MAXIMUM)],this._currentThreshold=this._maxFrameChangeThreshold[this._isForwardMovement?1:0]}set isForwardMovement(t){this._isResidualMovement=!1,this._isForwardMovement!==t&&(this._isForwardMovement=t,this._currentThreshold=this._maxFrameChangeThreshold[this._isForwardMovement?1:0])}setResidualMovement(){this._isResidualMovement=!0}changeFrame(t,e){this._counter++,this._counter>=this._currentThreshold&&(this._counter=0,this._frame^=1,t.frame=this._frame,e.frame=this._frame,this._isResidualMovement?this._currentThreshold<this._maxFrameChangeThreshold[this._isForwardMovement?1:0]&&this._currentThreshold++:this._currentThreshold>this._minFrameChangeThreshold[this._isForwardMovement?1:0]&&this._currentThreshold--)}stopped(){this._currentThreshold=this._maxFrameChangeThreshold[this._isForwardMovement?1:0]}}St.MIN_THRESHOLD_COEFF=17.5,St.MAX_THRESHOLD_COEFF=.5,St.MIN_FRAME_CHANGE_THRESHOLD_MINIMUM=2,St.MAX_FRAME_CHANGE_THRESHOLD_MAXIMUM=30;class Lt extends _t{constructor(){super(...arguments),this._frame=0,this._isEnded=!1,this._timer=0}changeFrame(t){this._timer+=t,this._timer>=this.UPDATE_TIMER_TIME&&(this._timer-=this.UPDATE_TIMER_TIME,this._frame++,this._frame>this.MAX_FRAME&&(this._frame=this.MAX_FRAME,this._isEnded=!0))}get isEnded(){return this._isEnded}}class Rt extends Lt{get UPDATE_TIMER_TIME(){return Rt.UPDATE_TIMER_TIME}get MAX_FRAME(){return Rt.MAX_FRAME}constructor(t,e){super(t,e,1),this._imgSprite.src="src/img/tanks/Effects/Sprites/Sprite_Effects_Smoke.png"}set frame(t){this._frame=t}get frame(){return this._frame}get originalWidth(){return Rt.ORIGINAL_SIZE}get originalHeight(){return Rt.ORIGINAL_SIZE}}Rt.UPDATE_TIMER_TIME=60,Rt.MAX_FRAME=9,Rt.ORIGINAL_SIZE=496;class Ct extends Rt{constructor(t,e){super(t,e)}get scaleX(){return-1}get scaleY(){return 1}calcPosition(t,e,i){return new x(t.x+this.width*e+this.height*i,t.y-this.width*i+this.height*e)}}class wt extends Rt{constructor(t,e,i){super(t,e),this._trackHeight=i}calcPosition(t,e,i){return new x(t.x-this._trackHeight*e+this.height*i,t.y+this._trackHeight*i+this.height*e)}}!function(t){t[t.rotLeft=-1]="rotLeft",t[t.rotStraight=0]="rotStraight",t[t.rotRight=1]="rotRight",t[t.rotNoRotate=2]="rotNoRotate"}(Tt||(Tt={}));class ft{constructor(t,e,i){this._delayedAngle=0,this._animationManager=t,this._width=e/4,this._height=e/5,this._trackHeight=i}detectRotateDirection(t){(t>=Math.PI/2&&t<=Math.PI&&this._delayedAngle>=-Math.PI&&this._delayedAngle<=-Math.PI/2||this._delayedAngle>=Math.PI/2&&this._delayedAngle<=Math.PI&&t>=-Math.PI&&t<=-Math.PI/2)&&(t=this._delayedAngle>=0?V(t,0,2*Math.PI):V(t,-2*Math.PI,0));const e=t-this._delayedAngle;return e<0&&Math.abs(e)>ft.UPDATE_SMOKE_DELTA_ANGLE?(this._delayedAngle=V(t,-Math.PI,Math.PI),Tt.rotLeft):e>0&&Math.abs(e)>ft.UPDATE_SMOKE_DELTA_ANGLE?(this._delayedAngle=V(t,-Math.PI,Math.PI),Tt.rotRight):Tt.rotNoRotate}setPosAndAngle(t,e){const i=Math.sin(e),s=Math.cos(e);Et.rotateToDefaultSpritePoint(this._currAnimation,t,i,s),this._currAnimation.point=t,this._currAnimation.angle=e}addAnimation(){this._animationManager.add(this._currAnimation)}spawnTopSmoke(t,e,i,s){this._currAnimation=new Ct(this._width,this._height);let n=this._currAnimation.calcPosition(t,i,s);const r=e+1.5708;this.setPosAndAngle(n,r),this.addAnimation()}spawnBottomSmoke(t,e,i,s){this._currAnimation=new wt(this._width,this._height,this._trackHeight);let n=this._currAnimation.calcPosition(t,i,s);const r=e+1.5708;this.setPosAndAngle(n,r),this.addAnimation()}}ft.UPDATE_SMOKE_DELTA_ANGLE=.113446;class Nt{constructor(t,e,i){this._tankSpriteParts=t,this._tankTrackEffect=new St(e,i)}get getParts(){return Object.values(this._tankSpriteParts)}get tankSpriteParts(){return this._tankSpriteParts}get tankTrackEffect(){return this._tankTrackEffect}get tankTireTrack(){return this._tankTireTrack}spawnTankAcceleration(t,e,i){this._tankAcceleration=new Mt(t,e,i)}removeAcceleration(){this._tankAcceleration.removeAcceleration()}spawnTireTracks(t,e,i,s){this._tankTireTrack=new pt(t,this._tankSpriteParts.topTrackSprite,s);const n=Math.sin(i),r=Math.cos(i),{topFirstChainPoint:a,bottomFirstChainPoint:o}=this._tankTireTrack.calcFirstTopBottomChainPoints(this._tankSpriteParts,e,n,r);this._tankTireTrack.spawnFullTireTrack(a,o,i,n,r)}spawnDriftSmoke(t){this._tankDrift=new ft(t,this._tankSpriteParts.topTrackSprite.width,this._tankSpriteParts.topTrackSprite.height)}updateTireTrack(t,e,i,s){const{topFirstChainPoint:n,bottomFirstChainPoint:r}=this._tankTireTrack.calcFirstTopBottomChainPoints(this._tankSpriteParts,t,i,s),{topLastChainPoint:a,bottomLastChainPoint:o}=this._tankTireTrack.calcLastTopBottomChainPoints(this._tankSpriteParts,t,i,s),{isUpdate:h,prevPoint:l,currPoint:c}=this._tankTireTrack.checkForUpdate(n,r,a,o);if(h){this._tankTireTrack.updateAllChainPoints(n,r,a,o);switch(this._tankTireTrack.detectMovementDirection(l,c,e)){case At.dirForward:this._tankTireTrack.forwardUpdate(n,r,e,i,s);break;case At.dirRotate:this._tankTireTrack.createTireTrackPair(a,o,e,i,s);break;case At.dirBackward:this._tankTireTrack.backwardUpdate(a,o,e,i,s)}}}updateDriftSmoke(t,e,i,s){let n=this._tankSpriteParts.hullSprite.calcPosition(t,i,s);n=this._tankSpriteParts.bottomTrackSprite.calcPosition(n,i,s);switch(this._tankDrift.detectRotateDirection(e)){case Tt.rotLeft:this._tankDrift.spawnTopSmoke(t,e,i,s);break;case Tt.rotRight:this._tankDrift.spawnBottomSmoke(n,e,i,s)}}updateForwardAction(t,e,i){this._tankTrackEffect.isForwardMovement=!0;const s=Math.sin(e),n=Math.cos(e),r=this._tankSpriteParts.hullSprite.calcPosition(t,s,n);this.updateSprite(t,e,i,s,n,r),this._tankAcceleration.setPosition(r,s,n,e),this.updateTireTrack(t,e,s,n),this.updateDriftSmoke(t,e,s,n)}updateBackwardAction(t,e,i){this._tankTrackEffect.isForwardMovement=!1;const s=Math.sin(e),n=Math.cos(e);this.defaultUpdate(t,e,i,s,n),this.updateTireTrack(t,e,s,n),this.updateDriftSmoke(t,e,s,n)}preUpdateAction(t,e,i){const s=Math.sin(e),n=Math.cos(e);this.updateTireTrack(t,e,s,n),this.updateDriftSmoke(t,e,s,n),this.defaultUpdate(t,e,i,s,n)}updateAfterAction(t,e,i){const s=Math.sin(e),n=Math.cos(e);this.defaultUpdate(t,e,i,s,n)}defaultUpdate(t,e,i,s,n){const r=this._tankSpriteParts.hullSprite.calcPosition(t,s,n);this.updateSprite(t,e,i,s,n,r)}rotateTurretUpdate(t,e,i,s){const n=Math.sin(e),r=Math.cos(e),a=this._tankSpriteParts.turretSprite,o=a.calcPosition(t,i,s),h=o.clone();Et.rotateForTurretPoint(a,h,i,s,n,r),Et.rotateToDefaultSpritePoint(a,o,i,s),Et.setPosAndAngle(a,o,e);let l=this._tankSpriteParts.weaponSprite.calcPosition(h,n,r);Et.updateSpritePart(this._tankSpriteParts.weaponSprite,l,n,r,e)}updateSprite(t,e,i,s,n,r){const a=this._tankSpriteParts.topTrackSprite,o=this._tankSpriteParts.bottomTrackSprite,h=this._tankSpriteParts.hullSprite;let l=a.calcPosition(t);Et.updateSpritePart(a,l,s,n,e),l=h.calcPosition(t,s,n),Et.updateSpritePart(h,l,s,n,e),l=o.calcPosition(r,s,n),Et.updateSpritePart(o,l,s,n,e),this.rotateTurretUpdate(r,i,s,n),this._tankTrackEffect.changeFrame(a,o)}}class Dt{constructor(t,e,i,s){this._hull=t,this._track=e,this._turret=i,this._weapon=s}get hull(){return this._hull}get track(){return this._track}get turret(){return this._turret}get weapon(){return this._weapon}}class Pt{constructor(){}static create(t,e,i,s){const n=Pt.createTurret(i),r=Pt.createWeapon(s),a=Pt.createHull(t),o=Pt.createTrack(e);return new Dt(a,o,n,r)}static createHull(h){switch(h){case 0:return new t;case 1:return new e;case 2:return new i;case 3:return new s;case 4:return new n;case 5:return new r;case 6:return new a;case 7:return new o;default:throw new Error(`Hull model ${h} was not found`)}}static createTrack(t){switch(t){case 0:return new h;case 1:return new l;case 2:return new c;case 3:return new _;default:throw new Error(`Track model ${t} was not found`)}}static createTurret(t){switch(t){case 0:return new I;case 1:return new M;case 2:return new S;case 3:return new L;case 4:return new R;case 5:return new C;case 6:return new w;case 7:return new f;default:throw new Error(`Turret model ${t} was not found`)}}static createWeapon(t){switch(t){case 0:return new N;case 1:return new D;case 2:return new P;case 3:return new y;case 4:return new O;case 5:return new k;case 6:return new H;case 7:return new v;default:throw new Error(`Weapon model ${t} was not found`)}}}class yt extends _t{get accelerationEffectIndentX(){return this._accelerationEffectIndentX}constructor(t,e){super(u.HULL_WIDTH[e],u.HULL_HEIGHT[e],4),this._accelerationEffectIndentX=u.ACCELERATION_EFFECT_INDENT_X[e],this._imgSprite.src=`src/img/tanks/Hulls/Hull_${e}/Hull_${t}.png`}calcPosition(t,e,i){return new x(t.x-u.TRACK_INDENT*e,t.y+u.TRACK_INDENT*i)}}class Ot extends _t{static calcHeight(t){return Ot.PROPORTION_WIDTH_HEIGHT*t}get num(){return this._num}constructor(t,e,i){super(e+u.TRACK_INDENT,i,3),this._frame=0,this._num=t,this._imgSprite.src=`src/img/tanks/Tracks/Track_${t}.png`}set frame(t){this._frame=t}get frame(){return this._frame}get originalWidth(){return Ot.ORIGINAL_WIDTH}get originalHeight(){return Ot.ORIGINAL_HEIGHT}}Ot.PROPORTION_WIDTH_HEIGHT=42/246,Ot.ORIGINAL_WIDTH=246,Ot.ORIGINAL_HEIGHT=42;class kt extends Ot{constructor(t,e){super(t,e,Ot.calcHeight(e))}calcPosition(t){return t.clone()}}class Ht extends Ot{constructor(t,e,i){const s=Ot.calcHeight(e);super(t,e,s),this._deltaHeight=i+u.TRACK_INDENT-s}calcPosition(t,e,i){return new x(t.x-this._deltaHeight*e,t.y+this._deltaHeight*i)}}class vt extends _t{constructor(t,e,i,s){super(u.TURRET_WIDTH[e],u.TURRET_HEIGHT[e],5),this._imgSprite.src=`src/img/tanks/Turrets/Turret_${e}/Turret_${t}.png`,this._indentX=i,this._indentY=s}calcPosition(t,e,i){return new x(t.x+this._indentX*i-this._indentY*e,t.y+this._indentY*i+this._indentX*e)}}class Gt extends _t{constructor(t,e,i){super(u.WEAPON_WIDTH[t],u.WEAPON_HEIGHT[t],5),this._imgSprite.src=`src/img/tanks/Weapons/Weapon_${t}.png`,this._indentX=e,this._indentY=i}calcPosition(t,e,i){return new x(t.x+this._indentX*i-this._indentY*e,t.y+this._indentY*i+this._indentX*e)}}class Ut{constructor(t,e,i,s,n){this._hullSprite=t,this._bottomTrackSprite=e,this._topTrackSprite=i,this._turretSprite=s,this._weaponSprite=n}get hullSprite(){return this._hullSprite}get bottomTrackSprite(){return this._bottomTrackSprite}get topTrackSprite(){return this._topTrackSprite}get turretSprite(){return this._turretSprite}get weaponSprite(){return this._weaponSprite}}class xt{constructor(){}static create(t,e,i,s,n){return new Ut(new yt(t,e),new Ht(i,u.HULL_WIDTH[e],u.HULL_HEIGHT[e]),new kt(i,u.HULL_WIDTH[e]),new vt(t,s,u.TURRET_INDENT_X[e],(u.HULL_HEIGHT[e]>>1)-(u.TURRET_HEIGHT[s]>>1)),new Gt(n,9*u.TURRET_WIDTH[s]/10,(u.TURRET_HEIGHT[s]>>1)-(u.WEAPON_HEIGHT[n]>>1)))}}class Ft{get model(){return this._model}get sprite(){return this._sprite}get id(){return this._model.entity.id}get tankInfo(){return this._tankInfo}set tankInfo(t){this._tankInfo=t}constructor(t,e,i){this._tankInfo=i;const s=Pt.create(i.hullNum,i.trackNum,i.turretNum,i.weaponNum),n=new z(t,u.getTankEntityWidth(i.hullNum),u.getTankEntityHeight(i.hullNum),e,s.turret.mass+s.hull.mass+s.weapon.mass,$.tankId);this._model=new lt(s,n);const r=s.track;this._sprite=new Nt(xt.create(i.color,i.hullNum,i.trackNum,i.turretNum,i.weaponNum),r.forwardData,r.backwardData)}spawn(t,e){const i=this._sprite.tankSpriteParts;t.insert(i.topTrackSprite),t.insert(i.bottomTrackSprite),t.insert(i.hullSprite),t.insert(i.weaponSprite),t.insert(i.turretSprite);const s=this._model.entity;e.insert(s),this._sprite.updateAfterAction(s.points[0],s.angle,this._model.turretAngle)}terminate(t,e){this._sprite.tankTireTrack.vanishFullTrack(),this._sprite.removeAcceleration();const i=this._sprite.tankSpriteParts;t.remove(i.topTrackSprite),t.remove(i.bottomTrackSprite),t.remove(i.hullSprite),t.remove(i.weaponSprite),t.remove(i.turretSprite),e.remove(this._model.entity)}adjustPosition(t,e){this.model.entity.adjustPolygon(t,u.getTankEntityWidth(this._tankInfo.hullNum),u.getTankEntityHeight(this._tankInfo.hullNum),e)}}class Wt{constructor(t,e){this._model=t,this._sprite=e}get model(){return this._model}get sprite(){return this._sprite}get id(){return this._model.entity.id}spawn(t,e){t.insert(this._sprite),e.insert(this._model.entity)}terminate(t,e){t.remove(this._sprite),e.remove(this._model.entity)}}class bt extends _t{constructor(t,e){super(u.WALL_WIDTH[e],u.WALL_HEIGHT[e],3),this._imgSprite.src=`src/img/blocks/${m[t]}_${E[e]}.png`}updateAfterAction(t,e){t=t.clone(),Et.rotateToDefaultSpritePoint(this,t,Math.sin(e),Math.cos(e)),Et.setPosAndAngle(this,t,e)}}class Bt extends nt{constructor(t){super(t,1/0)}get maxHealth(){return 1/0}}class Kt{constructor(){}static createWallsAroundPerimeter(t,e,i,s){const n=new Array,r=this.calcIndent(t,s.width),a=this.calcIndent(e,s.height-2*u.WALL_HEIGHT[0]);return this.createHorWalls(i,r,a,s,n),this.createVertWalls(i,r,a,s,n),{wallsArray:n,point:new x(r,a)}}static calcIndent(t,e){return(e-t*u.WALL_WIDTH[0])/2}static createHorWalls(t,e,i,s,n){for(let r=e;r<=s.width-e-u.WALL_WIDTH[this.RECT_NUM];r+=u.WALL_WIDTH[this.RECT_NUM])n.push(this.createWall(new x(r,i),0,t,this.RECT_NUM)),n.push(this.createWall(new x(r,s.height-u.WALL_HEIGHT[this.RECT_NUM]-i),0,t,this.RECT_NUM))}static createVertWalls(t,e,i,s,n){for(let r=i+u.WALL_HEIGHT[this.RECT_NUM]+(u.WALL_HEIGHT[this.RECT_NUM]>>1);r<=s.height-i-u.WALL_WIDTH[this.RECT_NUM];r+=u.WALL_WIDTH[this.RECT_NUM])n.push(this.createWall(new x(e-(u.WALL_HEIGHT[this.RECT_NUM]>>1),r),this.RAD_90,t,this.RECT_NUM)),n.push(this.createWall(new x(s.width-e-u.WALL_WIDTH[this.RECT_NUM]+(u.WALL_HEIGHT[this.RECT_NUM]>>1),r),this.RAD_90,t,this.RECT_NUM))}static createWall(t,e,i,s,n=!1){const r=n?g[i][s]:1/0,a=new Bt(new z(t,u.WALL_WIDTH[s],u.WALL_HEIGHT[s],e,r,$.wallId)),o=new bt(i,s);return o.point=t,o.angle=e,new Wt(a,o)}}Kt.RAD_90=Math.PI/2,Kt.RECT_NUM=0;class Vt{constructor(){}static calcGridPoints(t){const e={GRID_COLUMNS_AMOUNT:12,GRID_LINES_AMOUNT:6,GRID_COLUMNS:[],GRID_LINES:[]},i=3*u.WALL_WIDTH[0]/2;for(let s=0;s<e.GRID_COLUMNS_AMOUNT;s++)e.GRID_COLUMNS[s]=t.x+s*i;for(let s=0;s<e.GRID_LINES_AMOUNT;s++)e.GRID_LINES[s]=t.y+s*i;return e}static makeHorWallLine(t,e,i,s,n,r,a){if(t.y===r.GRID_LINES[0]||t.y===r.GRID_LINES[r.GRID_LINES.length-1])throw new Error("Horizontal wall line was made on the obstacle!");t.x!==r.GRID_COLUMNS[0]&&i&&n.push(Kt.createWall(t,0,a,1,!1));let o=new x(t.x+u.WALL_WIDTH[1],t.y);for(let i=0;i<e;i++){if(o.x>=r.GRID_COLUMNS[r.GRID_COLUMNS.length-1])throw new Error("Horizontal wall line was made on the obstacle!");n.push(Kt.createWall(new x(o.x,o.y),0,a,0,!1)),o=new x(o.x+u.WALL_WIDTH[0],t.y),i!==e-1?(n.push(Kt.createWall(new x(o.x,o.y),0,a,1,!1)),o=new x(o.x+u.WALL_WIDTH[1],t.y)):t.x+e*(u.WALL_WIDTH[0]+u.WALL_WIDTH[1])<r.GRID_COLUMNS[r.GRID_COLUMNS.length-1]&&s&&n.push(Kt.createWall(new x(o.x,o.y),0,a,1,!1))}}static makeVertWallLine(t,e,i,s,n,r,a){if(t.x===r.GRID_COLUMNS[0]||t.x===r.GRID_COLUMNS[r.GRID_COLUMNS.length-1])throw new Error("Vertical wall line was made on the obstacle!");let o=new x(t.x,t.y);o.y!==r.GRID_LINES[0]&&i&&n.push(Kt.createWall(o,0,a,1,!1)),o=new x(o.x,o.y+u.WALL_HEIGHT[1]);let h=new x(o.x+u.WALL_HEIGHT[0],o.y);b.rotatePointAroundTarget(h,new x(h.x-u.WALL_HEIGHT[0]/2,h.y+u.WALL_WIDTH[0]/2),Math.sin(-Math.PI/2),Math.cos(-Math.PI/2));for(let i=0;i<e;i++){if(o.y>=r.GRID_LINES[r.GRID_LINES.length-1])throw new Error("Vertical wall line was made on the obstacle!");n.push(Kt.createWall(new x(h.x,h.y),Math.PI/2,a,0,!1)),h=new x(h.x,h.y+u.WALL_WIDTH[0]),o=new x(o.x,o.y+u.WALL_WIDTH[0]),i!==e-1?(n.push(Kt.createWall(new x(o.x,o.y),0,a,1,!1)),o=new x(o.x,o.y+u.WALL_HEIGHT[1]),h=new x(h.x,h.y+u.WALL_HEIGHT[1])):t.y+e*(u.WALL_WIDTH[0]+u.WALL_HEIGHT[1])<r.GRID_LINES[r.GRID_LINES.length-1]&&s&&n.push(Kt.createWall(new x(o.x,o.y),0,a,1,!1))}}static createMazeLvl1(t,e){const i=Vt.calcGridPoints(e),s=new Array;return Vt.makeVertWallLine(new x(i.GRID_COLUMNS[1],i.GRID_LINES[1]),1,!0,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[0],i.GRID_LINES[2]),1,!0,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[1],i.GRID_LINES[3]),1,!0,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[1],i.GRID_LINES[4]),1,!1,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[2],i.GRID_LINES[4]),1,!1,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[2],i.GRID_LINES[0]),3,!0,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[2],i.GRID_LINES[3]),1,!1,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[3],i.GRID_LINES[1]),3,!0,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[3],i.GRID_LINES[2]),2,!1,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[5],i.GRID_LINES[2]),2,!1,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[5],i.GRID_LINES[3]),1,!1,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[4],i.GRID_LINES[4]),1,!0,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[4],i.GRID_LINES[3]),1,!0,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[5],i.GRID_LINES[0]),1,!0,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[4],i.GRID_LINES[1]),3,!0,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[6],i.GRID_LINES[1]),1,!1,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[6],i.GRID_LINES[4]),1,!0,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[8],i.GRID_LINES[1]),2,!0,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[7],i.GRID_LINES[2]),2,!0,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[7],i.GRID_LINES[2]),2,!1,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[9],i.GRID_LINES[2]),1,!1,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[9],i.GRID_LINES[3]),1,!1,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[8],i.GRID_LINES[3]),2,!0,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[8],i.GRID_LINES[4]),1,!1,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[9],i.GRID_LINES[1]),1,!0,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[10],i.GRID_LINES[1]),1,!1,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[10],i.GRID_LINES[2]),1,!1,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[10],i.GRID_LINES[4]),1,!0,!0,s,i,t),s}static createMazeLvl2(t,e){const i=Vt.calcGridPoints(e),s=new Array;return Vt.makeHorWallLine(new x(i.GRID_COLUMNS[0],i.GRID_LINES[1]),2,!0,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[2],i.GRID_LINES[1]),1,!1,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[3],i.GRID_LINES[0]),2,!0,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[3],i.GRID_LINES[2]),2,!1,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[5],i.GRID_LINES[1]),2,!0,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[5],i.GRID_LINES[1]),1,!1,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[5],i.GRID_LINES[3]),1,!1,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[4],i.GRID_LINES[0]),1,!0,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[0],i.GRID_LINES[4]),1,!0,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[1],i.GRID_LINES[2]),1,!0,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[1],i.GRID_LINES[3]),3,!1,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[2],i.GRID_LINES[3]),2,!1,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[7],i.GRID_LINES[0]),1,!0,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[6],i.GRID_LINES[4]),1,!1,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[3],i.GRID_LINES[4]),5,!0,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[7],i.GRID_LINES[2]),2,!1,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[6],i.GRID_LINES[2]),2,!0,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[8],i.GRID_LINES[1]),2,!0,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[9],i.GRID_LINES[0]),3,!0,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[9],i.GRID_LINES[3]),1,!1,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[10],i.GRID_LINES[1]),1,!0,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[10],i.GRID_LINES[2]),1,!1,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[9],i.GRID_LINES[4]),1,!0,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[9],i.GRID_LINES[4]),1,!1,!0,s,i,t),s}static createMazeLvl3(t,e){const i=Vt.calcGridPoints(e),s=new Array;return Vt.makeVertWallLine(new x(i.GRID_COLUMNS[1],i.GRID_LINES[0]),1,!0,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[0],i.GRID_LINES[2]),2,!0,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[0],i.GRID_LINES[4]),1,!0,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[3],i.GRID_LINES[0]),3,!0,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[2],i.GRID_LINES[1]),1,!0,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[1],i.GRID_LINES[3]),2,!0,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[2],i.GRID_LINES[4]),1,!0,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[4],i.GRID_LINES[3]),2,!0,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[3],i.GRID_LINES[4]),1,!0,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[6],i.GRID_LINES[0]),3,!0,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[4],i.GRID_LINES[1]),2,!0,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[6],i.GRID_LINES[2]),3,!1,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[7],i.GRID_LINES[1]),1,!0,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[9],i.GRID_LINES[1]),1,!0,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[9],i.GRID_LINES[1]),1,!1,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[8],i.GRID_LINES[0]),1,!0,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[6],i.GRID_LINES[4]),1,!1,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[5],i.GRID_LINES[4]),3,!0,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[5],i.GRID_LINES[2]),2,!0,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[4],i.GRID_LINES[2]),1,!0,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[7],i.GRID_LINES[3]),1,!0,!0,s,i,t),Vt.makeVertWallLine(new x(i.GRID_COLUMNS[9],i.GRID_LINES[3]),2,!1,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[8],i.GRID_LINES[3]),2,!0,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[10],i.GRID_LINES[2]),1,!0,!0,s,i,t),Vt.makeHorWallLine(new x(i.GRID_COLUMNS[10],i.GRID_LINES[4]),1,!0,!0,s,i,t),s}}class Xt extends _t{constructor(t){super(u.BACKGROUND_SIZE,u.BACKGROUND_SIZE,0),this._imgSprite.src=`src/img/backgrounds/${m[t]}_${ht(0,1)}.png`}}class Yt{constructor(){}static fullFillBackground(t,e,i){for(let s=0;s<e.width;s+=u.BACKGROUND_SIZE)for(let n=0;n<e.height;n+=u.BACKGROUND_SIZE)i.insert(this.addBackgroundTile(new x(s,n),t))}static addBackgroundTile(t,e){const i=new Xt(e);return i.point=t,i}}class Zt{constructor(){}static dotProduct(t,e){return t.x*e.x+t.y*e.y}static crossProduct(t,e){return t.x*e.y-t.y*e.x}static add(t,e){return new F(t.x+e.x,t.y+e.y)}static subtract(t,e){return new F(t.x-e.x,t.y-e.y)}static scale(t,e){return new F(t.x*e,t.y*e)}static createFromAngleAndLength(t,e){return new F(e*Math.cos(t),e*Math.sin(t))}static calcCoDirectionalScaleFactor(t,e){return t.x/e.x}static calcScaleFactor(t,e){return t.length/e.length}}class zt{constructor(){this.smallestOverlap=Number.MAX_VALUE,this.collisionAxis=null,this.isPolygon1Axis=!1}}class $t{constructor(){}static getAxes(t){const e=new Array,i=t.points.length-1;for(let s=0;s<i;s++)e.push(W.create(t.points[s],t.points[s+1]));return e.push(W.create(t.points[i],t.points[0])),e}static hasCollision(t,e,i,s){return $t.areProjectionsOverlapping(i,t,e)&&$t.areProjectionsOverlapping(s,t,e)}static areProjectionsOverlapping(t,e,i){for(const s of t){const t=$t.getProjection(e,s),n=$t.getProjection(i,s);if(Math.min(t.max-n.min,n.max-t.min)<=0)return!1}return!0}static getCollisionResult(t,e){const i=$t.getAxes(t),s=$t.getAxes(e),n=new zt;return $t.isSmallestOverlapAxisFound(i,!0,t,e,n)&&$t.isSmallestOverlapAxisFound(s,!1,t,e,n)?{collisionPoint:$t.findClosestVertex(t,e,n.collisionAxis,n.isPolygon1Axis),overlap:n.smallestOverlap}:null}static isSmallestOverlapAxisFound(t,e,i,s,n){for(const r of t){const t=$t.getProjection(i,r),a=$t.getProjection(s,r),o=Math.min(t.max-a.min,a.max-t.min);if(o<=0)return!1;o<n.smallestOverlap&&(n.smallestOverlap=o,n.collisionAxis=r,n.isPolygon1Axis=e)}return!0}static findClosestVertex(t,e,i,s){let n,r;var a,o;return!s||(a=t.angle,o=e.angle,Math.abs(Math.abs(a-o)-Math.PI/2)<d)?(n=this.getProjection(e,i),r=this.getExtendedProjection(t,i,!0)):(n=this.getProjection(t,i),r=this.getExtendedProjection(e,i,!1)),r.max-n.min<n.max-r.min?r.maxPoint:r.minPoint}static getExtendedProjection(t,e,i){let s=Zt.dotProduct(e,t.points[0]),n=s,r=t.points[0],a=t.points[0];for(let o=1;o<t.points.length;o++){const h=Zt.dotProduct(e,t.points[o]);h<s?(s=h,r=t.points[o]):h>n?(n=h,a=t.points[o]):i&&Math.abs(h-s)<this.EPSILON?r=Z(r,t.points[o]):i&&Math.abs(h-n)<this.EPSILON&&(a=Z(a,t.points[o]))}return{min:s,max:n,minPoint:r,maxPoint:a}}static getProjection(t,e){let i=Zt.dotProduct(e,t.points[0]),s=i;for(let n=1;n<t.points.length;n++){const r=Zt.dotProduct(e,t.points[n]);r<i?i=r:r>s&&(s=r)}return{min:i,max:s}}}$t.EPSILON=1;class jt{constructor(){}static resolveCollision(t,e){const i=$t.getCollisionResult(t,e);if(null===i)return null;const s=this.calcCollisionNormal(i.collisionPoint,t.calcCenter()),n=this.calcImpulseMagnitude(t,e,s)+this.calcAngularImpulseMagnitude(t,e);return this.separateEntities(t,i.overlap,s),this.updateAngularVelocity(t,e,i.collisionPoint,n,s),this.updateVelocity(t,e,n,s),i.collisionPoint}static updateAngularVelocity(t,e,i,s,n){const r=this.calcEntityNormal(t),a=Zt.subtract(i,e.calcCenter()),o=Zt.subtract(i,t.calcCenter()),h=Zt.crossProduct(a,n)*s,l=Zt.crossProduct(o,r)*s,c=h/e.momentOfInertia;let _=l/t.momentOfInertia;this.shouldReverseReceiving(e.angle,r.angle)&&(_=-_),e.angularVelocity+=c,t.angularVelocity+=_}static shouldReverseReceiving(t,e){const i=V(t-e,0,Math.PI);return i<Math.PI/2&&i>Math.PI/4||i>=Math.PI/2&&i<3*Math.PI/4}static calcEntityNormal(t){const e=t.angle;return X(Y(e,t.velocity.angle))?new F(-Math.cos(e),-Math.sin(e)):new F(Math.cos(e),Math.sin(e))}static updateVelocity(t,e,i,s){const n=Zt.scale(s,-i/t.mass),r=Zt.scale(s,i/e.mass);t.velocity.addVector(n),e.velocity.addVector(r)}static separateEntities(t,e,i){let s=-i.x*e,n=-i.y*e;s+=1===Math.sign(s)?this.CORRECTION_FACTOR:-this.CORRECTION_FACTOR,n+=1===Math.sign(n)?this.CORRECTION_FACTOR:-this.CORRECTION_FACTOR;for(const e of t.points)e.addToCoordinates(s,n);Math.abs(t.angularVelocity)>this.SMALL_ANGULAR_VELOCITY&&(t.angularVelocity-=1===Math.sign(t.angularVelocity)?this.CORRECTION_FACTOR/t.momentOfInertia:-this.CORRECTION_FACTOR/t.momentOfInertia)}static calcImpulseMagnitude(t,e,i){const s=Zt.subtract(t.velocity,e.velocity);return 2*Zt.dotProduct(s,i)/(1/t.mass+1/e.mass)*this.RETENTION_IMPULSE_COEFFICIENT}static calcAngularImpulseMagnitude(t,e){return Math.abs(t.angularVelocity-e.angularVelocity)/(1/t.momentOfInertia+1/e.momentOfInertia)*this.RETENTION_ANGULAR_IMPULSE_COEFFICIENT}static calcCollisionNormal(t,e){const i=Zt.subtract(t,e);return i.normalize(),i}}jt.RETENTION_IMPULSE_COEFFICIENT=.6,jt.RETENTION_ANGULAR_IMPULSE_COEFFICIENT=.006,jt.CORRECTION_FACTOR=.6,jt.SMALL_ANGULAR_VELOCITY=.001;class qt{constructor(){this._idForProcessing=new Array}hasForProcessing(){return 0!==this._idForProcessing.length}clear(){this._idForProcessing.length=0}push(t){this._idForProcessing.push(t)}get iterable(){return this._idForProcessing}}class Qt{constructor(t){this._collisionDetection=t}hasCollision(t){const e=this._collisionDetection.getCollisions(t);return function(t){for(const e of t)return!0;return!1}(e)?e:null}}class Jt{get wallsForProcessing(){return this._wallsForProcessing}get collisionChecker(){return this._collisionDetector}constructor(t){this._wallsForProcessing=new qt,this._collisionDetector=new Qt(t)}resolveCollision(t){const e=this._collisionDetector.hasCollision(t);if(e){const i=new Array;for(const s of e){const e=jt.resolveCollision(t,s);e&&(i.push({collisionPoint:e,id:s.id}),this.processCollision(s))}return i}return null}processCollision(t){$.isWall(t.id)&&this._wallsForProcessing.push(t.id)}}class te{constructor(t,e){this._rectangles=new Array,this._sprites=new Array,this._size=e,this._ctx=t,this._ctx.clearRect(0,0,this._size.width,this._size.height),this._bufferCanvas=document.createElement("canvas"),this._bufferCanvas.width=e.width,this._bufferCanvas.height=e.height,this._bufferCtx=this._bufferCanvas.getContext("2d")}get ctx(){return this._ctx}insert(t){const e=ct.extractZIndex(t.id);for(let t=this._sprites.length;t<=e;t++)this._sprites.push(new Map);t.imgSprite.complete?this._sprites[e].set(t.id,t):t.imgSprite.onload=()=>{this._sprites[e].set(t.id,t)}}remove(t){this.removeById(t)}removeById(t){t.imgSprite.onload=null;const e=ct.extractZIndex(t.id);this._sprites[e].delete(t.id)}drawAll(){this._bufferCtx.clearRect(0,0,this._size.width,this._size.height);for(const t of this._sprites)for(const e of t.values())this.draw(e);this.drawAdditionalShapes(),this._ctx.drawImage(this._bufferCanvas,0,0)}drawAdditionalShapes(){this.drawRectangles(),this._rectangles.length=0}drawRectangles(){for(const t of this._rectangles)this._bufferCtx.fillStyle=t.color,this._bufferCtx.fillRect(t.point.x,t.point.y,t.width,t.height)}addRectangle(t){this._rectangles.push(t)}clear(){this._sprites.length=0,this._rectangles.length=0}draw(t){this._bufferCtx.save();const e=t.width/2,i=t.height/2;"opacity"in t&&(this._bufferCtx.globalAlpha=t.opacity),this._bufferCtx.translate(t.point.x+e,t.point.y+i),this._bufferCtx.rotate(t.angle),function(t){return"scaleX"in t&&"scaleY"in t}(t)&&this._bufferCtx.scale(t.scaleX,t.scaleY),!function(t){return"frame"in t&&"originalWidth"in t&&"originalHeight"in t}(t)?this._bufferCtx.drawImage(t.imgSprite,-e,-i,t.width,t.height):this._bufferCtx.drawImage(t.imgSprite,t.frame*t.originalWidth,0,t.originalWidth,t.originalHeight,-e,-i,t.width,t.height),this._bufferCtx.restore()}}class ee{constructor(t,e,i,s,n){this._id=n,this._points=[new x(t,e),new x(i,e),new x(i,s),new x(t,s)],this._axes=[W.create(this._points[0],this._points[1]),W.create(this._points[1],this._points[2]),W.create(this._points[2],this._points[3]),W.create(this._points[3],this._points[0])]}get angle(){return ee.ANGLE}calcCenter(){return Z(this._points[0],this._points[2])}get id(){return this._id}get points(){return this._points}get axes(){return this._axes}}ee.ANGLE=0;class ie{constructor(t,e,i,s){this._boundary=new ee(t,e,i,s,$.quadtreeBoundaryId),this._root=new se(this._boundary)}insert(t){this._root.insert(t,$t.getAxes(t))}getCollisions(t){const e=new Map;return this._root.getCollisions(t,$t.getAxes(t),e),[...e.values()]}remove(t){this._root.remove(t,$t.getAxes(t))}clear(){this._root=new se(this._boundary)}}class se{constructor(t){this._totalPolygons=0,this._polygons=new Map,this._children=null,this._boundary=t}isSubdivide(){return null===this._polygons}subdivide(){const t=this._boundary.points[0].x,e=this._boundary.points[0].y,i=this._boundary.points[2].x,s=this._boundary.points[2].y,n=(i-t)/2,r=(s-e)/2;this._children=[new se(new ee(t,e,t+n,e+r,$.quadtreeBoundaryId)),new se(new ee(t+n,e,i,e+r,$.quadtreeBoundaryId)),new se(new ee(t,e+r,t+n,s,$.quadtreeBoundaryId)),new se(new ee(t+n,e+r,i,s,$.quadtreeBoundaryId))],this.redistribute()}redistribute(){this._totalPolygons=0;for(const t of this._polygons.values()){const e=$t.getAxes(t);for(const i of this._children)i.insert(t,e)}for(const t of this._children)this._totalPolygons+=t._totalPolygons;this._polygons=null}insert(t,e){if($t.hasCollision(this._boundary,t,this._boundary.axes,e))if(this.isSubdivide()){this._totalPolygons=0;for(const i of this._children)i.insert(t,e),this._totalPolygons+=i._totalPolygons}else this._totalPolygons++,this._polygons.set(t.id,t),this._polygons.size>se.CAPACITY&&this.subdivide()}remove(t,e){if($t.hasCollision(this._boundary,t,this._boundary.axes,e))if(this.isSubdivide()){this._totalPolygons=0;for(const i of this._children)i.remove(t,e),this._totalPolygons+=i._totalPolygons;this._totalPolygons<=se.HALF_CAPACITY&&this.mergeWithChildren()}else this._totalPolygons--,this._polygons.delete(t.id)}getCollisions(t,e,i){if(this.isSubdivide())for(const s of this._children)$t.hasCollision(this._boundary,t,this._boundary.axes,e)&&s.getCollisions(t,e,i);else for(const s of this._polygons.values())$t.hasCollision(t,s,e,$t.getAxes(s))&&i.set(s.id,s)}mergeWithChildren(){this._polygons=new Map;for(const t of this._children){t.isSubdivide()&&t.mergeWithChildren();for(const e of t._polygons.values())this._polygons.set(e.id,e)}this._totalPolygons=this._polygons.size,this._children=null}}se.CAPACITY=8,se.HALF_CAPACITY=se.CAPACITY>>1;class ne{set resistanceCoeff(t){this._resistanceCoeff=t}set airResistanceCoeff(t){this._airResistanceCoeff=t}constructor(t,e){this._resistanceCoeff=0,this._airResistanceCoeff=0,this._entityStorage=t,this._collisionResolver=e}get entityStorage(){return this._entityStorage}get collisionResolver(){return this._collisionResolver}}class re extends ne{residualMovement(t,e){const i=t.sprite;t.model.isIdle()?i.tankTrackEffect.stopped():(i.tankTrackEffect.setResidualMovement(),this.hullUpdate(t,t.model.residualMovement,B.movement,t.sprite.preUpdateAction,e))}residualAngularMovement(t,e){t.model.isAngularMotionStopped()||this.hullUpdate(t,t.model.residualAngularMovement,B.angularMovement,t.sprite.preUpdateAction,e)}turretCounterclockwiseMovement(t,e){t.model.turretCounterclockwiseMovement(e),re.turretUpdate(t)}turretClockwiseMovement(t,e){t.model.turretClockwiseMovement(e),re.turretUpdate(t)}counterclockwiseMovement(t,e){this.hullUpdate(t,t.model.counterclockwiseMovement,B.angularMovement,t.sprite.preUpdateAction,e)}clockwiseMovement(t,e){this.hullUpdate(t,t.model.clockwiseMovement,B.angularMovement,t.sprite.preUpdateAction,e)}forwardMovement(t,e){this.hullUpdate(t,t.model.forwardMovement,B.movement,t.sprite.updateForwardAction,e)}backwardMovement(t,e){this.hullUpdate(t,t.model.backwardMovement,B.movement,t.sprite.updateBackwardAction,e)}hullUpdate(t,e,i,s,n){const r=t.model.entity;this._entityStorage.remove(r),e.call(t.model,this._resistanceCoeff,this._airResistanceCoeff,n),i(r),this._collisionResolver.resolveCollision(r)&&t.sprite.removeAcceleration(),s.call(t.sprite,r.points[0],r.angle,t.model.turretAngle),this._entityStorage.insert(r)}static turretUpdate(t){const e=t.model,i=e.entity.angle,s=Math.sin(i),n=Math.cos(i);t.sprite.rotateTurretUpdate(t.sprite.tankSpriteParts.hullSprite.calcPosition(e.entity.points[0],s,n),e.turretAngle,s,n)}}class ae{constructor(){this._keys=new Set,this.handleKeyDown=t=>{this._keys.add(t.keyCode)},this.handleKeyUp=t=>{this._keys.delete(t.keyCode)}}addEventListeners(){document.addEventListener("keydown",this.handleKeyDown),document.addEventListener("keyup",this.handleKeyUp)}clearKeys(){this._keys.clear()}isKeyDown(t){return this._keys.has(t)}removeEventListeners(){document.removeEventListener("keydown",this.handleKeyDown),document.removeEventListener("keyup",this.handleKeyUp)}}class oe extends ne{constructor(t,e){super(t,e)}get collisionResolver(){return this._collisionResolver}residualAngularMovement(t,e){t.model.isAngularMotionStopped()||this.update(t,t.model.residualAngularMovement,B.angularMovement,e)}residualMovement(t,e){t.model.isIdle()||this.update(t,t.model.residualMovement,B.movement,e)}update(t,e,i,s){const n=t.model.entity;this._entityStorage.remove(n),e.call(t.model,this._resistanceCoeff,this._airResistanceCoeff,s),i(n),this._collisionResolver.resolveCollision(n),t.sprite.updateAfterAction(n.points[0],n.angle),this._entityStorage.insert(n)}isCompleteMotion(t){return t.model.isAngularMotionStopped()&&t.model.isIdle()}movement(t,e){this.residualAngularMovement(t,e),this.residualMovement(t,e)}}class he{constructor(t,e,i,s){this._movementManager=t,this._spriteStorage=e,this._elements=i,this._isResponsibleFor=s}get movementManager(){return this._movementManager}get isResponsibleFor(){return this._isResponsibleFor}get(t){return this._elements.has(t)?this._elements.get(t):null}add(t){for(const e of t)this._elements.has(e.id)||(this._elements.set(e.id,e),e.spawn(this._spriteStorage,this._movementManager.entityStorage))}delete(t){this._elements.has(t.id)&&(this._elements.delete(t.id),t.terminate(this._spriteStorage,this._movementManager.entityStorage))}}class le{constructor(t){this._vanishingListOfTirePairs=new mt,this.tanksAmount=0,this._storage=t}get vanishingListOfTirePairs(){return this.tanksAmount++,this._vanishingListOfTirePairs}removeTireTrackPair(t){this._storage.remove(t.topTire),this._storage.remove(t.bottomTire)}reduceOpacity(){let t=0;for(const e of this._vanishingListOfTirePairs){const i=this._vanishingListOfTirePairs.length*le.MIN_REDUCING_OPACITY_NUMBER/this.tanksAmount;e.topTire.opacity-=i,e.bottomTire.opacity-=i,e.topTire.opacity<=0&&t++}for(;t>0;t--)this.removeTireTrackPair(this._vanishingListOfTirePairs.tail),this._vanishingListOfTirePairs.removeFromTail()}}le.MIN_REDUCING_OPACITY_NUMBER=1e-4;class ce extends Lt{get UPDATE_TIMER_TIME(){return ce.UPDATE_TIMER_TIME}get MAX_FRAME(){return ce.MAX_FRAME}constructor(t,e){super(u.TANK_EXPLOSION_SIZE,u.TANK_EXPLOSION_SIZE,1),this._imgSprite.src="src/img/tanks/Effects/Sprites/Sprite_Effects_Explosion.png",this._point=new x(t.x-u.TANK_EXPLOSION_SIZE/2,t.y-u.TANK_EXPLOSION_SIZE/2),this._angle=e}set frame(t){this._frame=t}get frame(){return this._frame}get originalWidth(){return ce.ORIGINAL_SIZE}get originalHeight(){return ce.ORIGINAL_SIZE}}ce.UPDATE_TIMER_TIME=90,ce.MAX_FRAME=8,ce.ORIGINAL_SIZE=256;class _e extends Lt{get UPDATE_TIMER_TIME(){return _e.UPDATE_TIMER_TIME}get MAX_FRAME(){return _e.MAX_FRAME}constructor(t,e,i,s,n){super(i,s,1),this._imgSprite.src=`src/img/tanks/Effects/Sprites/Sprite_Fire_Shots_Impact_${0===n?0:1}.png`;const r=new x(t.x+s/2*Math.sin(e),t.y-s/2*Math.cos(e));Et.rotateToDefaultSpritePoint(this,r,Math.sin(e),Math.cos(e)),this._point=r,this._angle=e}set frame(t){this._frame=t}get frame(){return this._frame}get originalWidth(){return _e.ORIGINAL_WIDTH}get originalHeight(){return _e.ORIGINAL_HEIGHT}}_e.UPDATE_TIMER_TIME=70,_e.MAX_FRAME=3,_e.ORIGINAL_WIDTH=120,_e.ORIGINAL_HEIGHT=205;class ue extends Lt{get UPDATE_TIMER_TIME(){return ue.UPDATE_TIMER_TIME}get MAX_FRAME(){return ue.MAX_FRAME}constructor(t,e,i,s,n){super(i,s,1),this._imgSprite.src=`src/img/tanks/Effects/Sprites/Sprite_Fire_Shots_Shot_${0===n?0:1}.png`;const r=new x(t.x+s/2*Math.sin(e),t.y-s/2*Math.cos(e));Et.rotateToDefaultSpritePoint(this,r,Math.sin(e),Math.cos(e)),this._point=r,this._angle=e}set frame(t){this._frame=t}get frame(){return this._frame}get originalWidth(){return ue.ORIGINAL_WIDTH}get originalHeight(){return ue.ORIGINAL_HEIGHT}}ue.UPDATE_TIMER_TIME=45,ue.MAX_FRAME=3,ue.ORIGINAL_WIDTH=135,ue.ORIGINAL_HEIGHT=202;class de extends Lt{get UPDATE_TIMER_TIME(){return de.UPDATE_TIMER_TIME}get MAX_FRAME(){return de.MAX_FRAME}constructor(t,e,i){super(i,i,1),this._imgSprite.src="src/img/tanks/Effects/Sprites/Grenade_Effects_Explosion.png",this._point=new x(t.x-i/2,t.y-i/2),this._angle=e}set frame(t){this._frame=t}get frame(){return this._frame}get originalWidth(){return de.ORIGINAL_SIZE}get originalHeight(){return de.ORIGINAL_SIZE}}de.UPDATE_TIMER_TIME=50,de.MAX_FRAME=9,de.ORIGINAL_SIZE=800;class me{static playDeathAnimation(t,e){if($.isWall(e.id),$.isTank(e.id))return new ce(e.model.entity.calcCenter(),ht(-Math.PI,Math.PI));if($.isBullet(e.id)){const i=e;return this.playImpactAnimation(t,i.model.entity.angle+Math.PI,i.sprite.num)}}static playImpactAnimation(t,e,i){return new _e(t,e,5*u.BULLET_WIDTH[i],5*u.BULLET_HEIGHT[i],i)}static playShootAnimation(t,e,i){return new ue(t,e,5*u.BULLET_WIDTH[i],5*u.BULLET_HEIGHT[i],i)}static playGrenadeExplosionAnimation(t,e,i){return new de(t,i,e)}}class Ee{constructor(t){this._animationManager=t}get animationManager(){return this._animationManager}createImpactAnimation(t,e){this._animationManager.add(me.playImpactAnimation(t,e.model.entity.angle+Math.PI,e.sprite.num))}createExplosionAnimation(t,e,i){this._animationManager.add(me.playGrenadeExplosionAnimation(t,e,i))}createDeadAnimation(t,e){this._animationManager.add(me.playDeathAnimation(t,e))}}class ge{constructor(t){this._animationManager=t}get animationManager(){return this._animationManager}createShootAnimation(t,e){this._animationManager.add(me.playShootAnimation(Z(t.entity.points[0],t.entity.points[3]),t.entity.angle,e))}}class Ae extends _t{get num(){return this._num}constructor(t){super(u.BULLET_WIDTH[t],u.BULLET_HEIGHT[t],3),this._imgSprite.src=`src/img/tanks/Bullets/Bullet_${t}.png`,this._num=t}updateAfterAction(t,e){t=t.clone(),Et.rotateToDefaultSpritePoint(this,t,Math.sin(e),Math.cos(e)),Et.setPosAndAngle(this,t,e)}}class Te{constructor(t,e,i){this._model=t,this._sprite=new Ae(e),this._source=i}get id(){return this._model.entity.id}get model(){return this._model}get sprite(){return this._sprite}spawn(t,e){t.insert(this._sprite),e.insert(this._model.entity)}terminate(t,e){t.remove(this._sprite),e.remove(this._model.entity)}get source(){return this._source}}class pe extends he{constructor(t,e,i,s,n,r,a){super(t,e,i,$.isTank),this._addBulletElement=s,this._KeyHandler=r,this._tankAnimator=new ge(n),this._tireTracksManager=new le(e),this._bonusCollisionManager=a}handle(t){this._tireTracksManager.reduceOpacity();for(const e of this._elements.values()){const i=e.tankInfo.control;let s=this._KeyHandler.isKeyDown(i.turretClockwiseKey),n=this._KeyHandler.isKeyDown(i.turretCounterClockwiseKey);if((s&&!n||!s&&n)&&(s?this._movementManager.turretClockwiseMovement(e,t):n&&this._movementManager.turretCounterclockwiseMovement(e,t)),s=this._KeyHandler.isKeyDown(i.forwardKey),n=this._KeyHandler.isKeyDown(i.backwardKey),s&&!n||!s&&n?s?this._movementManager.forwardMovement(e,t):n&&(e.sprite.removeAcceleration(),this._movementManager.backwardMovement(e,t)):(e.sprite.removeAcceleration(),this._movementManager.residualMovement(e,t)),s=this._KeyHandler.isKeyDown(i.hullClockwiseKey),n=this._KeyHandler.isKeyDown(i.hullCounterClockwiseKey),s&&!n||!s&&n?s?this._movementManager.clockwiseMovement(e,t):n&&this._movementManager.counterclockwiseMovement(e,t):this._movementManager.residualAngularMovement(e,t),s=this._KeyHandler.isKeyDown(i.shootKey),s){const t=e.model.shot();if(t){const i=e.model.bulletNum;this._tankAnimator.createShootAnimation(t,i),this._addBulletElement.addElement(new Te(t,i,e))}}this._bonusCollisionManager.checkForBonusHits(e)}}add(t){super.add(t);for(const e of t){const t=e.sprite,i=e.model.entity;t.spawnTireTracks(this._spriteStorage,i.points[0],i.angle,this._tireTracksManager.vanishingListOfTirePairs),t.spawnDriftSmoke(this._tankAnimator.animationManager);const s=t.tankSpriteParts.hullSprite;t.spawnTankAcceleration(this._spriteStorage,s.accelerationEffectIndentX,s.height)}}}class Ie extends he{constructor(t,e,i){super(t,e,i,$.isWall),this._wallToProcess=new mt,this.action=(t,e)=>this._movementManager.movement(t,e),this.removalCondition=t=>this._movementManager.isCompleteMotion(t)}addToProcess(){const t=this._movementManager.collisionResolver.wallsForProcessing;if(t.hasForProcessing()){for(const e of t.iterable)this._wallToProcess.addToTail(this._elements.get(e));t.clear()}}handle(t){this.addToProcess(),this._wallToProcess.isEmpty()||this._wallToProcess.applyAndRemove(this.action,this.removalCondition,t)}}class Me{constructor(t){this._animationList=new mt,this.action=(t,e)=>t.changeFrame(e),this.removalCondition=t=>(t.isEnded&&this._storage.removeById(t),t.isEnded),this._storage=t}add(t){this._storage.insert(t),this._animationList.addToTail(t)}handle(t){this._animationList.isEmpty()||this._animationList.applyAndRemove(this.action,this.removalCondition,t)}}class Se extends he{constructor(t,e,i,s,n,r,a){super(t,e,i,$.isBullet),this._handlingManagers=s,this._bulletAnimator=new Ee(n),this._killProcessor=r,this._healthManager=a}handle(t){if(0!==this._elements.size){const e=new Array;for(const i of this._elements.values())this._movementManager.movement(i,t),this._movementManager.hasResidualMovement(i)||e.push(i);for(const t of e)this.delete(t)}this._movementManager.bulletCollisionDates.hasForProcessing()&&this.handleBulletCollisions()}handleBulletCollisions(){for(const t of this._movementManager.bulletCollisionDates.iterable)this.handleBulletDeletion(t),this.handleExplosiveBullet(t),this.handleCollisionPacks(t);this._movementManager.bulletCollisionDates.clear()}handleCollisionPacks(t){for(const e of t.collisionPacks){const i=e.id,s=this.getElementHandling(i),n=s.get(i);n&&(n.model.takeDamage(t.bulletElement.model),n.model.isDead()?(s.delete(n),this._bulletAnimator.createDeadAnimation(e.collisionPoint,n),this._healthManager.remove(n.model),this._killProcessor.processKill(t.bulletElement.source,n)):this._healthManager.add(n.model))}}handleExplosiveBullet(t){const e=function(t){for(const e of t)return e;return null}(t.collisionPacks).collisionPoint,i=t.bulletElement.model.isExplosiveBullet;if(i){const s=u.GRENADE_EXPLOSION_SIZE+ht(-30,30),n=ht(-Math.PI,Math.PI);this._bulletAnimator.createExplosionAnimation(e,s,n);const r=i.createAffectedArea(e,s,n);t.collisionPacks=this._movementManager.collisionResolver.resolveCollision(r)}else this._bulletAnimator.createImpactAnimation(e,t.bulletElement)}handleBulletDeletion(t){this.delete(t.bulletElement),this._healthManager.remove(t.bulletElement.model)}getElementHandling(t){for(const e of this._handlingManagers)if(e.isResponsibleFor(t))return e}}class Le{constructor(t,e,i){this._elements=t,this._storage=e,this._bulletMovementManager=i}addElement(t){this._elements.has(t.id)||this._bulletMovementManager.checkForSpawn(t)&&(this._elements.set(t.id,t),t.spawn(this._storage,this._bulletMovementManager.entityStorage))}}class Re{constructor(){}static movePolygon(t,e){for(const i of t.points)i.addToCoordinates(e.x,e.y)}static rotatePolygon(t,e){const i=Math.sin(e),s=Math.cos(e),n=t.calcCenter();for(const e of t.points)b.rotatePointAroundTarget(e,n,i,s)}}class Ce extends ne{constructor(){super(...arguments),this._bulletCollisionDates=new qt}get bulletCollisionDates(){return this._bulletCollisionDates}hasResidualMovement(t){return!t.model.isIdle()}movement(t,e){t.model.isIdle()||this.update(t,e)}update(t,e){const i=t.model.entity;this._entityStorage.remove(i),t.model.residualMovement(this._airResistanceCoeff,e);const s=Zt.createFromAngleAndLength(i.velocity.angle,i.movementLength);let n=!1;const r=Math.floor(Zt.calcCoDirectionalScaleFactor(i.velocity,s));for(let e=r;e>0;e--){Re.movePolygon(i,s);const e=this._collisionResolver.resolveCollision(i);if(e){this._bulletCollisionDates.push({bulletElement:t,collisionPacks:e}),n=!0;break}}if(!n){s.scale(-r),s.addVector(i.velocity),Re.movePolygon(i,s);const e=this._collisionResolver.resolveCollision(i);e&&this._bulletCollisionDates.push({bulletElement:t,collisionPacks:e})}t.sprite.updateAfterAction(i.points[0],i.angle),this._entityStorage.insert(i)}checkForSpawn(t){const e=t.model.entity,i=this._collisionResolver.resolveCollision(e);return i?(this._bulletCollisionDates.push({bulletElement:t,collisionPacks:i}),!1):(t.sprite.updateAfterAction(e.points[0],e.angle),!0)}}class we{constructor(){this._executioners=new Array}add(...t){this._executioners.push(...t)}renderAll(t){for(const e of this._executioners)e.handle(t)}}class fe{constructor(t){this._isRunning=!1,this._isActivate=!1,this._render=new we,this.gameLoop=t=>{if(this._isRunning){if(this._isActivate){const e=t.valueOf();this._render.renderAll(e-this._lastFrameTime),this._drawable.drawAll(),this._lastFrameTime=e}requestAnimationFrame(this.gameLoop)}},this._drawable=t}get render(){return this._render}start(){this._isRunning||(this._isRunning=!0,this.resume(),requestAnimationFrame(this.gameLoop))}stop(){this._isRunning=!1}pause(){this._isActivate=!1}resume(){this._isActivate=!0,this._lastFrameTime=performance.now()}}class Ne{get collisionChecker(){return this._collisionDetector}constructor(t,e,i){this._items=new Map,this._spriteStorage=t;const s=new ie(0,0,i.width,i.height);this._collectibleStorage=s,this._collisionDetector=new Qt(s),this._bonusManager=e}addElements(t){for(const e of t)this.addElement(e)}addElement(t){this._items.has(t.id)||(this._items.set(t.id,t),t.spawn(this._spriteStorage,this._collectibleStorage))}checkForBonusHits(t){const e=this._collisionDetector.hasCollision(t.model.entity);if(e)for(const i of e)this._bonusManager.addBonus(t,i.bonus)&&this.delete(this._items.get(i.id))}delete(t){this._items.delete(t.id),t.terminate(this._spriteStorage,this._collectibleStorage)}}class De{get point(){return this._point}get width(){return this._width}get height(){return this._height}get color(){return this._color}constructor(t,e,i,s){this._point=t,this._width=e,this._height=i,this._color=s}}class Pe{constructor(t){this._drawList=new Map,this._shapeAdder=t}add(t){t.maxHealth!==1/0&&this._drawList.set(t.entity.id,t)}remove(t){this._drawList.delete(t.entity.id)}handle(){this.drawBars()}drawBars(){for(const t of this._drawList.values())this.drawBar(t)}drawBar(t){const e=this.calculateTankWidth(t),i=e/t.maxHealth*t.health,s=K(t.entity.points[1],t.entity.points[2]),n=t.entity.calcCenter(),r=new x(n.x-i/2,n.y-1.5*s);var a;this.drawHealthBar(r,i,this.getHealthColor(t)),"armor"in(a=t)&&"armorStrength"in a&&"maxArmor"in a&&this.drawArmorBar(t,e,r)}calculateTankWidth(t){return 1.15*K(t.entity.points[0],t.entity.points[1])}getHealthColor(t){return t.health>.4*t.maxHealth?"green":t.health>.15*t.maxHealth&&t.health<=.4*t.maxHealth?"yellow":"red"}drawHealthBar(t,e,i){this._shapeAdder.addRectangle(new De(t,e,u.HEALTH_BAR_HEIGHT,i))}drawArmorBar(t,e,i){const s=e/t.maxArmor*t.armor,n=t.entity.calcCenter(),r=new x(n.x-s/2,i.y+u.HEALTH_BAR_HEIGHT+u.HEALTH_ARMOR_BAR_INDENT_Y);this._shapeAdder.addRectangle(new De(r,s,u.ARMOR_BAR_HEIGHT,"blue"))}}class ye{get modelCollisionManager(){return this._modelCollisionManager}get itemCollisionManager(){return this._itemCollisionManager}get size(){return this._size}get ctx(){return this._canvas.ctx}constructor(t,e,i){this._handlingManagers=new Array,this._keyHandler=new ae,this.handleVisibilityChange=()=>{document.hidden?(this._gameLoop.pause(),this._keyHandler.clearKeys()):this._gameLoop.resume()},this._size=e,this._canvas=new te(t,this._size),this._gameLoop=new fe(this._canvas),this._animationManager=new Me(this._canvas),this._healthDrawManager=new Pe(this._canvas);const s=new ie(0,0,this._size.width,this._size.height);this._modelCollisionManager=new Jt(s);const n=new Map,r=new Map,a=new Map,o=new re(s,this._modelCollisionManager),h=new oe(s,this._modelCollisionManager),l=new Ce(s,this._modelCollisionManager),c=new Le(a,this._canvas,l);this._itemCollisionManager=new Ne(this._canvas,i,this._size),this._tankHandlingManagers=new pe(o,this._canvas,n,c,this._animationManager,this._keyHandler,this._itemCollisionManager),this._wallHandlingManagers=new Ie(h,this._canvas,r),this._bulletHandlingManager=new Se(l,this._canvas,a,this._handlingManagers,this._animationManager,i,this._healthDrawManager),this._handlingManagers.push(this._tankHandlingManagers,this._wallHandlingManagers,this._bulletHandlingManager),this._gameLoop.render.add(...this._handlingManagers,this._animationManager,this._healthDrawManager),this._gameLoop.start()}addEventListeners(){this._keyHandler.addEventListeners(),document.addEventListener("visibilitychange",this.handleVisibilityChange)}removeEventListeners(){this._keyHandler.removeEventListeners(),document.removeEventListener("visibilitychange",this.handleVisibilityChange)}setBackgroundMaterial(t){this.setCoefficients(t),this.createBackgroundSprites(t)}setCoefficients(t){for(const e of this._handlingManagers)e.movementManager.resistanceCoeff=A[t],e.movementManager.airResistanceCoeff=15e-7}createBackgroundSprites(t){Yt.fullFillBackground(t,this._size,this._canvas)}addWallElements(t){this._wallHandlingManagers.add(t)}addTankElements(...t){this._tankHandlingManagers.add(t);for(const e of t)this._healthDrawManager.add(e.model)}addBonuses(...t){this._itemCollisionManager.addElements(t)}addExecutioners(...t){this._gameLoop.render.add(...t)}finishGame(){this._gameLoop.stop(),this.ctx.clearRect(0,0,this._size.width,this._size.height)}}class Oe{constructor(t,e){this._collectible=t,this._sprite=e}get id(){return this._collectible.id}get collectible(){return this._collectible}get sprite(){return this._sprite}spawn(t,e){t.insert(this._sprite),e.insert(this._collectible)}terminate(t,e){t.remove(this._sprite),e.remove(this._collectible)}adjustPosition(t,e){this._collectible.adjustPolygon(t,this._sprite.width,this._sprite.height,e),this._sprite.point=t,this._sprite.angle=e}}class ke{constructor(t,e,i,s,n,r){this._id=n,this._bonus=r,this.adjustPolygon(t,e,i,s)}get bonus(){return this._bonus}get id(){return this._id}get points(){return this._points}calcCenter(){return Z(this._points[0],this._points[2])}adjustPolygon(t,e,i,s){this._points=[t.clone(),new x(t.x+e,t.y),new x(t.x+e,t.y+i),new x(t.x,t.y+i)],0!==s&&Re.rotatePolygon(this,s)}get angle(){return Math.atan2(this._points[1].y-this._points[0].y,this._points[1].x-this._points[0].x)}}class He extends _t{constructor(t,e){super(u.KEY_SIZE,u.KEY_SIZE,6),this._scaleX=1,this._isIncreasing=!1,this._point=t,this._angle=e,this._imgSprite.src="src/img/item/Key.png"}get scaleX(){return this._isIncreasing?(this._scaleX+=He.CHANGE_SCALE_X_NUMBER,this._scaleX>=1&&(this._isIncreasing=!1)):(this._scaleX-=He.CHANGE_SCALE_X_NUMBER,this._scaleX<=-1&&(this._isIncreasing=!0)),this._scaleX}get scaleY(){return 1}}He.CHANGE_SCALE_X_NUMBER=.01;class ve extends _t{constructor(t,e,i){switch(super(u.BOX_SIZE,u.BOX_SIZE,6),this._point=e,this._angle=i,t){case p.bulLight:this._imgSprite.src="src/img/item/Light_Bullet_Box.png";break;case p.bulMedium:this._imgSprite.src="src/img/item/Medium_Bullet_Box.png";break;case p.bulHeavy:this._imgSprite.src="src/img/item/Heavy_Bullet_Box.png";break;case p.bulGrenade:this._imgSprite.src="src/img/item/Grenade_Bullet_Box.png";break;case p.bulSniper:this._imgSprite.src="src/img/item/Sniper_Bullet_Box.png";break;default:throw new Error(`Unsupported bulletType: ${t}`)}}}class Ge{constructor(){}static create(t,e,i){const s=$.collectibleItemId;switch(t){case p.key:return new Oe(new ke(e,u.KEY_SIZE,u.KEY_SIZE,i,s,t),new He(e,i));case p.bulLight:case p.bulMedium:case p.bulHeavy:case p.bulSniper:case p.bulGrenade:return new Oe(new ke(e,u.BOX_SIZE,u.BOX_SIZE,i,s,t),new ve(t,e,i))}}}class Ue{constructor(t,e){this._ammoSpawnInterval=5e3,this._timer=0,this._spawnPoints=t,this._collectibleItemManager=e}handle(t){this._timer+=t,this._timer>=this._ammoSpawnInterval&&(this.spawnRandomBox(this.getRandomBox(),this._spawnPoints.getRandomSpawnPoint(u.BOX_SIZE,u.BOX_SIZE)),this._timer=0,this._ammoSpawnInterval<Ue.MAX_AMMO_SPAWN_INTERVAL&&(this._ammoSpawnInterval+=ht(1e3,5e3)))}getRandomBox(){const t=ht(1,100);return t<40?p.bulMedium:t<70?p.bulSniper:t<85?p.bulHeavy:p.bulGrenade}spawnRandomBox(t,e){const i=Ge.create(t,e,0);for(let t=0;t<Ue.RESPAWN_TRYS_AMOUNT;t++){if(!this._collectibleItemManager.collisionChecker.hasCollision(i.collectible)){this._collectibleItemManager.addElement(i);break}i.adjustPosition(this._spawnPoints.getRandomSpawnPoint(u.BOX_SIZE,u.BOX_SIZE),0)}}randomSpawn(t,e,i,s,n,r,a){const o=Ge.create(t,this._spawnPoints.getRandomSpawnPoint(e,i,s,n,r,a),0);for(let t=0;t<Ue.RESPAWN_TRYS_AMOUNT;t++){if(!this._collectibleItemManager.collisionChecker.hasCollision(o.collectible))return void this._collectibleItemManager.addElement(o);o.adjustPosition(this._spawnPoints.getRandomSpawnPoint(e,i,s,n,r,a),0)}throw new Error("Failed to spawn all the keys")}spawn(t,e,i,s,n){const r=Ge.create(t,this._spawnPoints.getSpawnPoint(e,i,s,n),0);this._collectibleItemManager.addElement(r)}}Ue.MAX_AMMO_SPAWN_INTERVAL=6e4,Ue.RESPAWN_TRYS_AMOUNT=5;class xe{constructor(t,e,i){this._spawnPoints=[],this._spawnGridsLinesAmount=e,this._spawnGridsColumnsAmount=i,this.calcSpawnPoints(t)}calcSpawnPoints(t){const e=new x(t.x+u.WALL_WIDTH[0],t.y+u.WALL_HEIGHT[0]+u.WALL_WIDTH[0]/2),i=u.WALL_WIDTH[0]+u.WALL_WIDTH[1],s=u.WALL_WIDTH[0]+u.WALL_HEIGHT[1];for(let t=0;t<this._spawnGridsLinesAmount;t++){this._spawnPoints[t]=[];for(let n=0;n<this._spawnGridsColumnsAmount;n++)this._spawnPoints[t][n]=new x(e.x+i*n,e.y+s*t)}}getRandomSpawnPoint(t,e,i=0,s=this._spawnGridsLinesAmount-1,n=0,r=this._spawnGridsColumnsAmount-1){const a=ht(i,s),o=ht(n,r),h=this._spawnPoints[a][o];return new x(h.x-t/2,h.y-e/2)}getSpawnPoint(t,e,i,s){const n=this._spawnPoints[i][s];return new x(n.x-t/2,n.y-e/2)}}class Fe{constructor(t,e,i){this._spawnPoints=t,this._collisionChecker=e,this._tankElementAdder=i}randomSpawn(t,e,i,s,n){const r=new Ft(this._spawnPoints.getRandomSpawnPoint(u.getTankEntityWidth(t.hullNum),u.getTankEntityHeight(t.hullNum),e,i,s,n),Fe.getRandomAngle(),t);for(let a=0;a<Fe.RESPAWN_TRYS_AMOUNT;a++){if(!this._collisionChecker.hasCollision(r.model.entity))return this._tankElementAdder.addTankElements(r),r;r.adjustPosition(this._spawnPoints.getRandomSpawnPoint(u.getTankEntityWidth(t.hullNum),u.getTankEntityHeight(t.hullNum),e,i,s,n),Fe.getRandomAngle())}throw new Error("Failed to spawn the tank")}static getRandomAngle(){return Fe.ANGLES[ht(0,3)]}}Fe.RESPAWN_TRYS_AMOUNT=5,Fe.ANGLES=[0,1.57,3.14,4.71];class We{constructor(){}static start(t,e,i){const s=We.createInfoPanel(t);u.setResolutionResizeCoeff(t.width);const n={width:t.width,height:t.height};We.createMaze1(t.getContext("2d"),n,s,e,i)}static createMaze1(t,e,i,s,n){We.createMaze(t,e,1,2,s,n,i,Vt.createMazeLvl1,We.createMaze2)}static createMaze2(t,e,i,s,n){We.createMaze(t,e,2,1,s,n,i,Vt.createMazeLvl2,We.createMaze3)}static createMaze3(t,e,i,s,n){We.createMaze(t,e,0,0,s,n,i,Vt.createMazeLvl3,We.giveAttackerVictory)}static giveAttackerVictory(t,e,i,s,n){We.completeGame(t,e,i,!0)}static completeGame(t,e,i,s){const n=new Image(e.width,e.height);n.src="src/img/cat.jpg",n.onload=()=>{t.drawImage(n,0,0,e.width,e.height),i.keyPanel.textContent=s?"The attacker wins":"The defender wins",i.timePanel.remove()}}static createMaze(t,e,i,s,n,r,a,o,h){const{wallsArray:l,point:c}=Kt.createWallsAroundPerimeter(17,7,s,e),_=new xe(c,5,T),u=new be(n,r,h,a,t,e,_,We.completeGame),d=u.gameMaster;d.setBackgroundMaterial(i),d.addWallElements(l),d.addWallElements(o(s,c));const m=new Ue(_,d.itemCollisionManager);We.addKeys(m),d.addExecutioners(new Ke(u),new Be(u),m),d.addEventListeners()}static addKeys(t){for(let e=0;e<We.AMOUNT_OF_KEYS;e++)t.randomSpawn(p.key,u.KEY_SIZE,u.KEY_SIZE,0,4,Math.ceil(5.5),10)}static createInfoPanel(t){t.style.top=`${We.PANEL_HEIGHT}%`,t.style.height=100-We.PANEL_HEIGHT+"%";const e=document.createElement("div");e.id="info-panel",e.style.height=`${We.PANEL_HEIGHT}%`,document.body.appendChild(e);const i=document.createElement("div");i.id="time-count",e.appendChild(i);const s=document.createElement("div");return s.id="key-count",e.appendChild(s),{keyPanel:s,timePanel:i}}}We.AMOUNT_OF_KEYS=3,We.PANEL_HEIGHT=5;class be{constructor(t,e,i,s,n,r,a,o){this._score=0,this._panelInfo=s,this._gameMaster=new ye(n,r,this),this._nextMaze=i,this._completeGame=o,this._tankSpawnManager=new Fe(a,this._gameMaster.modelCollisionManager.collisionChecker,this._gameMaster),this.randomAttackerSpawn(t),this.randomDefenderSpawn(e)}randomAttackerSpawn(t){this._attacker=this._tankSpawnManager.randomSpawn(t,0,4,0,Math.floor(5.5))}randomDefenderSpawn(t){this._defender=this._tankSpawnManager.randomSpawn(t,0,4,Math.ceil(5.5),10)}addBonus(t,e){switch(e){case p.key:if(t===this._attacker)return this._score++,this.endGameConditions()&&this.processPostGameActions(),!0;break;case p.bulGrenade:case p.bulHeavy:case p.bulLight:case p.bulMedium:case p.bulSniper:if(t instanceof Ft)return t.model.takeBullet(e),!0}return!1}processKill(t,e){e===this._attacker?this.randomAttackerSpawn(this._attacker.tankInfo):e===this._defender&&this.randomDefenderSpawn(this._defender.tankInfo)}endGameConditions(){return 3===this._score}processPostGameActions(){this._gameMaster.removeEventListeners(),this._gameMaster.finishGame(),this._nextMaze(this._gameMaster.ctx,this._gameMaster.size,this._panelInfo,this._attacker.tankInfo,this._defender.tankInfo)}giveDefenderVictory(){this._gameMaster.removeEventListeners(),this._gameMaster.finishGame(),this._completeGame(this._gameMaster.ctx,this._gameMaster.size,this._panelInfo,!1)}get score(){return this._score}get keyPanel(){return this._panelInfo.keyPanel}get timePanel(){return this._panelInfo.timePanel}get gameMaster(){return this._gameMaster}get finishTime(){return be.FINISH_TIME}}be.FINISH_TIME=300;class Be{constructor(t){this._elapsedTime=0,this._counter=0,this._timeInfo=t}handle(t){this._counter+=t,this._counter>=Be.SECOND&&(this._counter-=Be.SECOND,this.updatePanel())}updatePanel(){this._timeInfo.timePanel.textContent="Elapsed time: "+ ++this._elapsedTime,this._elapsedTime>this._timeInfo.finishTime&&this._timeInfo.giveDefenderVictory()}}Be.SECOND=1e3;class Ke{constructor(t){this._lastScore=1/0,this._scoreData=t}handle(){this._lastScore!==this._scoreData.score&&(this._lastScore=this._scoreData.score,this.updatePanel())}updatePanel(){this._scoreData.keyPanel.textContent=`Amount of Keys: ${this._lastScore}`}}class Ve{constructor(){}static selectGame(t,e,i,s){if(0===t)We.start(e,i,s)}static gameStart(t,e,i=0){!function(){const t=document.body;for(;t.firstChild;)t.removeChild(t.firstChild)}();const s=document.createElement("canvas");s.width=window.screen.width,s.height=window.screen.height,s.className="canvas",s.id="canvas",document.body.appendChild(s),Ve.selectGame(i,s,t,e)}}(new G).start(Ve.gameStart,document.querySelectorAll("button"))})();